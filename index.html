<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="audio-chain-system.js"></script>
    <script src="sound-engines.js"></script>
    <script src="ocean-waves.js"></script>
    <script src="melody-instruments.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1 class="mood-header">Mood</h1>
        <p>Each composition is unique and evolves over time using generative principles.</p>
    </div>

    <div class="main-controls">
        <!-- Dice Randomizer -->
        <div class="dice-section">
            <button class="dice-button" id="dice-button">
                <span class="dice-icon">🎲</span>
                Randomize Everything
            </button>
        </div>

        <!-- Mood Section -->
        <div class="control-section" id="mood-section">
            <div class="section-header" onclick="toggleSection('mood')">
                <div class="section-title">
                    <div class="section-icon mood-icon">🎭</div>
                    <div>
                        <div class="section-info">Mood</div>
                        <div class="section-status" id="mood-status">Calm</div>
                    </div>
                </div>
                <button class="expand-btn" id="mood-expand">
                    <span>▼</span>
                </button>
            </div>
            <div class="section-content" id="mood-content">
                <div class="control-group">
                    <label class="control-label" for="sound-engine">Sound Engine</label>
                    <select id="sound-engine">
                        <option value="standard">Standard Ambient</option>
                        <option value="cathedral-ethereal">Ethereal Cathedral</option>
                        <option value="glacial-ethereal">Glacial Ethereal</option>
                        <option value="dark-matter">Dark Matter</option>
                        <option value="aurora-field">Aurora Field</option>
                        <option value="glass-horizon">Glass Horizon</option>
                        <option value="nebula-drift">Nebula Drift</option>
                        <option value="thermal-layers">Thermal Layers</option>
                        <option value="deep-resonance">Deep Resonance</option>
                        <option value="cosmic-drift">Cosmic Drift</option>
                        <option value="underwater-palace">Underwater Palace</option>
                        <option value="neon-nocturne">Neon Nocturne</option>
                        <option value="atmospheric-temple">Atmospheric Temple</option>
                        <option value="stone-focus">Stone in Focus</option>
                        <option value="string-theory">String Theory</option>
                        <option value="hexagon-sun">Hexagon Sun</option>
                        <option value="parallel-dimension">Parallel Dimension</option>
                        <option value="gentle-rhubarb">Gentle Rhubarb</option>
                        <option value="ethereal-rhubarb">Ethereal Rhubarb</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label" for="mood">Musical Mood</label>
                    <select id="mood" onchange="updateMoodStatus()">
                        <option value="random">Random (Auto-changing)</option>
                        <option value="calm">Calm</option>
                        <option value="ethereal">Ethereal</option>
                        <option value="mysterious">Mysterious</option>
                        <option value="melancholic">Melancholic</option>
                        <option value="hopeful">Hopeful</option>
                        <option value="dreamy">Dreamy</option>
                        <option value="nostalgic">Nostalgic</option>
                        <option value="peaceful">Peaceful</option>
                        <option value="serene">Serene</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label" for="density">Note Density</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="density" min="1" max="10" value="5">
                        </div>
                        <div class="slider-labels">
                            <span>Sparse</span>
                            <span>Dense</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="reverb">Reverb Amount</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="reverb" min="0" max="1" step="0.1" value="0.5">
                        </div>
                        <div class="slider-labels">
                            <span>Dry</span>
                            <span>Wet</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Melody Section -->
        <div class="control-section" id="melody-section">

            <div class="section-header" onclick="toggleSection('melody')">
                <div class="section-title">
                    <div class="toggle-btn" onclick="toggleMelody(event)">
                        <input type="checkbox" id="melody-toggle" onchange="updateMelodyStatus()" onclick="event.stopPropagation()">
                        <span class="toggle-indicator"></span>
                    </div>
                    <div class="section-icon melody-icon">🎹</div>
                    <div>
                        <div class="section-info">Melodic Instruments</div>
                        <div class="section-status" id="melody-status">Soft Piano</div>
                    </div>
                </div>
                <button class="expand-btn" id="melody-expand">
                    <span>▼</span>
                </button>
            </div>
            <div class="section-content" id="melody-content">
                <div class="control-group">
                    <label class="control-label" for="melodic-instrument">Instrument Type</label>
                    <select id="melodic-instrument" onchange="updateMelodyStatus()">
                        <option value="random">Random (Auto-changing)</option>
                        <option value="piano" selected>Soft Piano</option>
                        <option value="marimba">Marimba</option>
                        <option value="harp">Harp</option>
                        <option value="music-box">Music Box</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label" for="melodic-frequency">Note Frequency</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="melodic-frequency" min="1" max="10" value="4">
                        </div>
                        <div class="slider-labels">
                            <span>Rare</span>
                            <span>Often</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="melodic-reverb">Melodic Reverb</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="melodic-reverb" min="0" max="1" step="0.05" value="0.8">
                        </div>
                        <div class="slider-labels">
                            <span>Dry</span>
                            <span>Wet</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ocean Waves Section -->
        <div class="control-section" id="waves-section">
            <div class="section-header" onclick="toggleSection('waves')">
                <div class="section-title">
                    <div class="toggle-btn" onclick="toggleWaves()">
                        <input type="checkbox" id="noise-toggle" onchange="updateWavesStatus()" onclick="event.stopPropagation()">
                        <span class="toggle-indicator"></span>
                    </div>
                    <div class="section-icon waves-icon">🌊</div>
                    <div>
                        <div class="section-info">Ocean Waves</div>
                        <div class="section-status" id="waves-status">Off</div>
                    </div>
                </div>
                <button class="expand-btn" id="waves-expand">
                    <span>▼</span>
                </button>
            </div>

            <div class="section-content" id="waves-content">
                <!-- Single column controls -->
                <div class="control-group">
                    <label class="control-label" for="noise-volume">Wave Volume</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="noise-volume" min="-15" max="5" step="1" value="-6">
                        </div>
                        <div class="slider-labels">
                            <span>Quiet</span>
                            <span>Loud</span>
                        </div>
                    </div>
                </div>

                <!-- Two-column layout for detailed controls -->
                <div class="waves-grid">
                    <!-- Left column - Wave Characteristics -->
                    <div class="waves-column">
                        <h4 class="column-header">Wave Characteristics</h4>

                        <div class="control-group">
                            <label class="control-label" for="base-level">Base Level</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="base-level" min="0" max="0.3" step="0.01" value="0.05">
                                </div>
                                <div class="slider-labels">
                                    <span>Silent</span>
                                    <span>Audible</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="peak-level">Peak Level</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="peak-level" min="0.1" max="0.8" step="0.01" value="0.4">
                                </div>
                                <div class="slider-labels">
                                    <span>Gentle</span>
                                    <span>Powerful</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="build-speed">Build Speed</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="build-speed" min="0.5" max="5" step="0.1" value="2">
                                </div>
                                <div class="slider-labels">
                                    <span>Slow</span>
                                    <span>Fast</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="noise-type">Noise Type</label>
                            <select id="noise-type">
                                <option value="white">White (Bright)</option>
                                <option value="pink" selected>Pink (Natural)</option>
                                <option value="brown">Brown (Deep)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Right column - Timing & Filter -->
                    <div class="waves-column">
                        <h4 class="column-header">Timing & Filter</h4>

                        <div class="control-group">
                            <label class="control-label" for="min-duration">Min Duration (s)</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="min-duration" min="2" max="15" step="0.5" value="4">
                                </div>
                                <div class="slider-labels">
                                    <span>2s</span>
                                    <span>15s</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="max-duration">Max Duration (s)</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="max-duration" min="5" max="25" step="0.5" value="12">
                                </div>
                                <div class="slider-labels">
                                    <span>5s</span>
                                    <span>25s</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="pause-between">Pause Between (s)</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="pause-between" min="0.5" max="8" step="0.25" value="2">
                                </div>
                                <div class="slider-labels">
                                    <span>0.5s</span>
                                    <span>8s</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="filter-freq">Filter Frequency</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="filter-freq" min="200" max="8000" step="50" value="2000">
                                </div>
                                <div class="slider-labels">
                                    <span>200 Hz</span>
                                    <span>8000 Hz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings section -->
        <div class="control-section" id="settings-section">
            <div class="section-header" onclick="toggleSection('settings')">
                <div class="section-title">
                    <div class="section-icon settings-icon">⚙️</div>
                    <div>
                        <div class="section-info">Settings</div>
                    </div>
                </div>
                <button class="expand-btn" id="settings-expand">
                    <span>▼</span>
                </button>
            </div>
            <div class="section-content" id="settings-content">
                <div class="control-group">
                    <label class="control-label" for="volume">Master Volume</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="volume" min="-30" max="0" step="1" value="-15">
                        </div>
                        <div class="slider-labels">
                            <span>🔇 Quiet</span>
                            <span>Loud 🔊</span>
                        </div>
                    </div>
                </div>

                <div class="control-group" id="settings-random-interval">
                    <label class="control-label" for="random-interval">Random Change Interval</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="random-interval" min="1" max="30" step="1" value="10">
                        </div>
                        <div class="slider-labels">
                            <span>1 min</span>
                            <span>30 min</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Playback Controls -->
    <div class="playback-controls">
        <button class="play-button" id="start">Generate Music</button>
        <button class="stop-button" id="stop" disabled>Stop Music</button>
    </div>

    <!-- Visualizer -->
    <div class="visualizer" id="waves">
    </div>

    <div class="info">
        <p>By <a href="https://github.com/mrbarge/mood">mrbarge</a>, with ❤️ to <a href="https://tonejs.github.io/">tone.js</a></p>
    </div>
</div>

<script>

    // Initialize the new sound system
    const musicManager = new AmbientMusicManager();

    let waveManager = null;

    // Sound Engine UI element reference
    const soundEngineSelect = document.getElementById("sound-engine");

    // Toggle section expansion
    function toggleSection(sectionName) {
        const section = document.getElementById(`${sectionName}-section`);
        const content = document.getElementById(`${sectionName}-content`);
        const expandBtn = document.getElementById(`${sectionName}-expand`);

        const isExpanded = section.classList.contains('expanded');

        if (isExpanded) {
            section.classList.remove('expanded');
            content.classList.remove('expanded');
            expandBtn.classList.remove('expanded');
        } else {
            section.classList.add('expanded');
            content.classList.add('expanded');
            expandBtn.classList.add('expanded');
        }
    }

    // Update status displays
    function updateMoodStatus() {
        const mood = document.getElementById('mood');
        const status = document.getElementById('mood-status');
        status.textContent = mood.options[mood.selectedIndex].text;
    }

    function updateMelodyStatus() {
        const instrument = document.getElementById('melodic-instrument');
        const status = document.getElementById('melody-status');
        status.textContent = instrument.options[instrument.selectedIndex].text;
    }

    function updateWavesStatus() {
        const toggle = document.getElementById('noise-toggle');
        const status = document.getElementById('waves-status');
        status.textContent = toggle.checked ? 'On' : 'Off';
    }

    // Dice randomizer
    function randomizeEverything() {
        const diceButton = document.getElementById('dice-button');

        diceButton.style.transform = 'scale(0.95)';
        diceButton.innerHTML = '<span class="dice-icon">🎲</span> Rolling...';

        setTimeout(() => {
            // Randomize mood
            const moodSelect = document.getElementById('mood');
            const moodOptions = Array.from(moodSelect.options).filter(option => option.value !== 'random');
            const randomMood = moodOptions[Math.floor(Math.random() * moodOptions.length)];
            moodSelect.value = randomMood.value;

            // Randomize sound engine
            if (soundEngineSelect) {
                const engineOptions = Array.from(soundEngineSelect.options);
                const randomEngine = engineOptions[Math.floor(Math.random() * engineOptions.length)];
                soundEngineSelect.value = randomEngine.value;
            }

            // Randomize melody
            const melodySelect = document.getElementById('melodic-instrument');
            const melodyOptions = Array.from(melodySelect.options);
            const randomMelody = melodyOptions[Math.floor(Math.random() * melodyOptions.length)];
            melodySelect.value = randomMelody.value;

            // Randomize waves
            const wavesToggle = document.getElementById('noise-toggle');
            wavesToggle.checked = Math.random() > 0.5;
            if (waveManager) {
                waveManager.updateStatus();
            }

            // Randomize some sliders
            document.getElementById('density').value = Math.floor(Math.random() * 8) + 2;
            document.getElementById('reverb').value = (Math.random() * 0.8 + 0.2).toFixed(1);
            document.getElementById('melodic-frequency').value = Math.floor(Math.random() * 8) + 2;

            // Apply changes gradually if music is playing
            if (isPlaying) {
                applySettingsGradually();
            }

            // Update status displays
            updateMoodStatus();
            updateMelodyStatus();
            updateWavesStatus();

            // Reset button
            diceButton.style.transform = 'scale(1)';
            diceButton.innerHTML = '<span class="dice-icon">🎲</span> Randomize Everything';
        }, 500);
    }

    // Event listeners

    document.getElementById('dice-button').addEventListener('click', randomizeEverything);

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        waveManager = new OceanWaveManager();
        updateMoodStatus();
        updateMelodyStatus();

        melodyManager = new MelodyManager();
        musicManager.setSoundEngine('standard', {
            density: parseInt(densitySlider.value),
            reverbAmount: parseFloat(reverbSlider.value)
        });
    });

    // Initialize variables
    let isPlaying = false;
    let activeNotes = {};
    let currentMelodicSynth = null;

    let visualizerInterval = null;
    let currentActiveMood = "calm"; // Default starting mood

    // Create audio context and effects
    const masterVolume = new Tone.Volume(-15).toDestination();

    const reverb = new Tone.Reverb({
        decay: 10,
        wet: 0.5,
        preDelay: 0.01
    }).connect(masterVolume);

    const delay = new Tone.FeedbackDelay({
        delayTime: "8n",
        feedback: 0.4,
        wet: 0.3
    }).connect(reverb);

    const filter = new Tone.Filter({
        type: "lowpass",
        frequency: 2000,
        Q: 1
    }).connect(delay);

    // Initialize UI elements
    const startButton = document.getElementById("start");
    const stopButton = document.getElementById("stop");
    const moodSelect = document.getElementById("mood");
    const densitySlider = document.getElementById("density");
    const reverbSlider = document.getElementById("reverb");
    const wavesContainer = document.getElementById("waves");

    // Melody
    const melodyToggle = document.getElementById("melody-toggle");
    const melodicInstrumentSelect = document.getElementById("melodic-instrument");
    const melodicFrequencySlider = document.getElementById("melodic-frequency");
    const melodicReverbSlider = document.getElementById("melodic-reverb");

    // Control random-ness
    const randomIntervalSlider = document.getElementById("random-interval");

    const noiseToggle = document.getElementById("noise-toggle");

    // Create wave elements for visualizer
    for (let i = 0; i < 40; i++) {
        const wave = document.createElement("div");
        wave.className = "wave";
        wavesContainer.appendChild(wave);
    }

    // Event listeners
    startButton.addEventListener("click", startMusic);
    stopButton.addEventListener("click", stopMusic);

    // Sound engine change handler
    if (soundEngineSelect) {
        soundEngineSelect.addEventListener("change", async function() {
            if (isPlaying) {
                await handleSoundEngineChange();
            }
        });
    }

    // Function to handle sound engine changes
    async function handleSoundEngineChange() {
        const selectedEngine = soundEngineSelect.value;
        console.debug("Sound engine changed to:", selectedEngine);

        await musicManager.setSoundEngine(selectedEngine, {
            density: parseInt(densitySlider.value),
            reverbAmount: parseFloat(reverbSlider.value)
        });
    }

    reverbSlider.addEventListener("input", (e) => {
        reverb.wet.value = parseFloat(e.target.value);
        musicManager.updateConfig({ reverbAmount: parseFloat(e.target.value) });
    });

    // Density slider listener (updates sound engine)
    densitySlider.addEventListener("input", (e) => {
        musicManager.updateConfig({ density: parseInt(e.target.value) });
    });

    const volumeSlider = document.getElementById("volume");
    volumeSlider.addEventListener("input", (e) => {
        masterVolume.volume.value = parseInt(e.target.value);
    });

    noiseToggle.addEventListener("change", toggleWaves);
    melodyToggle.addEventListener("change", toggleMelody);
    melodicReverbSlider.addEventListener("input", function() {
        const reverbAmount = parseFloat(this.value);
        console.debug("Setting melodic reverb to:", reverbAmount);
        if (melodyManager) {
            melodyManager.updateReverbAmount(reverbAmount);
        }
    });

    melodicInstrumentSelect.addEventListener("change", function() {
        // If we're currently playing, handle instrument change
        if (isPlaying) {
            handleInstrumentChange();
        }
    });

    moodSelect.addEventListener("change", function() {
        if (isPlaying) {
            handleMoodChange();
        }
    });

    window.addEventListener('beforeunload', function() {
        if (melodyManager) {
            melodyManager.dispose();
        }
    });

    // Scale definitions for different moods
    const scales = {
        calm: ["C3", "D3", "E3", "G3", "A3", "C4", "D4", "E4", "G4", "A4", "C5"],
        ethereal: ["D3", "F#3", "A3", "B3", "D4", "F#4", "A4", "B4", "D5"],
        mysterious: ["C3", "D#3", "F3", "G#3", "B3", "C4", "D#4", "F4", "G#4", "B4"],
        melancholic: ["A2", "C3", "D3", "E3", "F3", "A3", "C4", "D4", "E4", "F4", "A4"],
        hopeful: ["G3", "A3", "B3", "D4", "E4", "G4", "A4", "B4", "D5", "E5"],
        dreamy: ["C3", "D3", "E3", "F#3", "G3", "A3", "B3", "C4", "D4", "E4", "F#4", "G4", "A4", "B4", "C5"],
        nostalgic: ["A2", "B2", "C3", "D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4"],
        peaceful: ["D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5"],
        mystical: ["E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5", "E5"],
        celestial: ["C3", "D3", "E3", "F#3", "G#3", "A#3", "C4", "D4", "E4", "F#4", "G#4", "A#4", "C5"],
        contemplative: ["A2", "C3", "D3", "E3", "G3", "A3", "C4", "D4", "E4", "G4", "A4", "C5", "D5", "E5"],
        serene: ["C3", "D3", "E3", "G3", "A3", "C4", "D4", "E4", "G4", "A4", "C5", "D5", "E5", "G5"],
        wandering: ["G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5", "E5", "F5", "G5"],
        introspective: ["A2", "B2", "C3", "D3", "E3", "F3", "G#3", "A3", "B3", "C4", "D4", "E4", "F4", "G#4", "A4"],
        minimalist: ["C3", "E3", "G3", "D4", "F4", "A4", "C5", "E5", "G5"],
        suspended: ["C3", "D3", "F3", "G3", "C4", "D4", "F4", "G4", "C5", "D5", "F5"],
        twilight: ["C3", "Eb3", "F3", "Gb3", "G3", "Bb3", "C4", "Eb4", "F4", "Gb4", "G4", "Bb4", "C5"]
    };

    const melodicPatterns = {
        calm: ["E4", "G4", "C5"],
        ethereal: ["F#4", "B4", "D5"],
        mysterious: ["D#4", "G#4", "C5"],
        melancholic: ["C4", "E4", "A4"],
        hopeful: ["B4", "D5", "G4"],
        dreamy: ["E4", "F#4", "A4", "B4"],
        nostalgic: ["C4", "E4", "F4", "A4"],
        peaceful: ["D4", "F4", "A4", "C5"],
        mystical: ["F4", "G4", "C5", "D5"],
        celestial: ["D4", "F#4", "A#4", "C5"],
        contemplative: ["C4", "E4", "G4"],
        serene: ["E4", "G4", "C5"],
        wandering: ["G4", "C5", "F5"],
        introspective: ["E4", "F4", "G#4"],
        minimalist: ["E4", "G4"],
        suspended: ["D4", "F4", "G4"],
        twilight: ["Eb4", "Gb4", "Bb4"]
    };

    let melodyManager = null;

    // Function to handle mood changes
    function handleMoodChange() {
        const selectedMood = moodSelect.value;
        console.debug("Mood changed to:", selectedMood);

        if (selectedMood !== "random") {
            currentActiveMood = selectedMood;
            musicManager.setMood(selectedMood);
        } else {
            musicManager.startRandomMoodCycle();
        }
    }

    async function handleInstrumentChange() {
        if (!melodyManager) return;

        const selectedInstrument = melodicInstrumentSelect.value;
        console.debug("Instrument changed to:", selectedInstrument);

        if (selectedInstrument !== "random" && melodyToggle.checked) {
            // Set specific instrument
            await melodyManager.setInstrument(selectedInstrument, {
                volume: -5,
                reverbAmount: parseFloat(melodicReverbSlider.value)
            });

            // Start if currently playing
            if (isPlaying) {
                const effectiveMood = moodSelect.value === "random" ? currentActiveMood : moodSelect.value;
                const currentScale = scales[effectiveMood];
                const melodicPattern = melodicPatterns[effectiveMood];

                await melodyManager.start(currentScale, melodicPattern);
            }
        } else if (selectedInstrument === "random") {
            melodyManager.startRandomCycle();
        } else if (!melodyToggle.checked) {
            melodyManager.stop();
        }
    }

    function toggleMelody(event) {
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        console.debug("toggleMelody() called");
        updateMelodyStatus();

        // Update melody manager state
        melodyManager.setEnabled(melodyToggle.checked);

        if (isPlaying) {
            handleInstrumentChange();
        }
    }

    async function startMusic() {
        if (isPlaying) return;

        await Tone.start();

        isPlaying = true;
        activeNotes = {};

        startButton.disabled = true;
        stopButton.disabled = false;

        // Set initial sound engine if none selected
        const selectedEngine = soundEngineSelect?.value || 'standard';
        console.debug("I picked ", selectedEngine);
        await musicManager.setSoundEngine(selectedEngine, {
            density: parseInt(densitySlider.value),
            reverbAmount: parseFloat(reverbSlider.value)
        });

        // Initialize currentActiveMood
        if (moodSelect.value !== "random") {
            currentActiveMood = moodSelect.value;
        } else {
            const availableMoods = musicManager.getAvailableMoods();
            currentActiveMood = availableMoods[Math.floor(Math.random() * availableMoods.length)];
        }

        // Set mood
        musicManager.setMood(currentActiveMood);

        if (moodSelect.value === "random") {
            musicManager.startRandomMoodCycle();
        }

        // Update audio settings
        reverb.wet.value = parseFloat(reverbSlider.value);
        masterVolume.volume.value = parseInt(document.getElementById("volume").value);

        Tone.Transport.bpm.value = 60;
        Tone.Transport.start();

        // Start the sound engine
        await musicManager.start();

        // Handle melodic instruments (unchanged)
        if (melodyToggle.checked) {
            await handleInstrumentChange();
        }

        startVisualizer();
    }

    function stopMusic() {
        isPlaying = false;

        // Stop the sound engine
        musicManager.stop();

        if (melodyManager) {
            melodyManager.stop();
        }

        Tone.Transport.stop();

        startButton.disabled = false;
        stopButton.disabled = true;

        if (visualizerInterval) {
            clearInterval(visualizerInterval);
            visualizerInterval = null;
        }

        activeNotes = {};

        console.log("Music stopped successfully");
    }

    function startVisualizer() {
        // Clear any existing interval
        if (visualizerInterval) {
            clearInterval(visualizerInterval);
        }

        const waves = document.querySelectorAll('.wave');

        visualizerInterval = setInterval(() => {
            // Update each wave based on audio activity
            waves.forEach((wave, index) => {
                if (isPlaying) {

                    // Change color based on active instruments
                    if (noiseToggle.checked && index % 4 === 0) {
                        // Blue-green for ocean waves
                        wave.style.backgroundColor = `hsla(${180 + Math.random() * 40}, 80%, 70%, 0.2)`;
                    } else if (melodicInstrumentSelect.value !== "none" && index % 5 === 0) {
                        // Gold/yellow for melodic instruments
                        wave.style.backgroundColor = `hsla(${40 + Math.random() * 20}, 90%, 65%, 0.25)`;
                    } else {
                        // Create random but smooth movements
                        const heightPercent = Math.random() * 50 + 10;
                        wave.style.height = `${heightPercent}%`;

                        // Add some color variation based on active notes
                        const hue = (index * 9) % 360;
                        wave.style.backgroundColor = `hsla(${hue}, 80%, 70%, 0.2)`;
                    }

                } else {
                    wave.style.height = "30%";
                    wave.style.backgroundColor = "rgba(255, 255, 255, 0.2)";
                }
            });
        }, 200);
    }

    function applySettingsGradually() {
        if (!isPlaying) return;

        // Gradually ramp reverb changes
        const targetReverb = parseFloat(reverbSlider.value);
        reverb.wet.rampTo(targetReverb, 1.5);
        // Handle mood change during playback
        if (moodSelect.value !== "random") {
            currentActiveMood = moodSelect.value;
            musicManager.setMood(currentActiveMood);
        }

        // Handle sound engine change during playback
        if (soundEngineSelect) {
            handleSoundEngineChange();
        }

        // Handle instrument change during playback
        handleInstrumentChange();

        // Update wave system settings if active
        if (waveManager && waveManager.isActive()) {
            waveManager.updateVolume();
            waveManager.updateNoiseType();
            waveManager.updateFilter();
            waveManager.updateBaseLevel();
        }

        // Update configuration
        musicManager.updateConfig({
            density: parseInt(densitySlider.value),
            reverbAmount: parseFloat(reverbSlider.value)
        });
    }

    async function toggleWaves() {
        if (!waveManager) {
            waveManager = new OceanWaveManager();
        }
        await waveManager.toggle();
    }

</script>
</body>
</html>