<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="js/audio-chain-system.js"></script>
    <script src="js/melody-instruments.js"></script>
    <script src="js/multi-melody-system.js"></script>
    <script src="js/sound-engines.js"></script>
    <script src="js/ocean-waves.js"></script>
    <script src="js/grandfather-clock.js"></script>
    <script src="js/thunder-system.js"></script>
    <script src="js/sleep-manager.js"></script>
    <script src="js/preset-manager.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* Header */
        .header {
            padding: 25px 20px 15px;
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 100;
            margin-bottom: 5px;
            letter-spacing: 0.5rem;
        }

        .header p {
            opacity: 0.8;
            font-size: 0.85rem;
        }

        /* Big Play Button */
        .big-play-section {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .big-play-button {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            border: none;
            color: white;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
        }

        .big-play-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
        }

        .big-play-button.stop {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
        }

        .play-status {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .quick-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .quick-btn.sleep.active {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        /* Current Settings Display */
        .current-settings {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .current-title {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 8px;
            text-align: center;
        }

        .current-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            text-align: center;
        }

        .current-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 8px;
            border-radius: 8px;
        }

        .current-label {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-bottom: 2px;
        }

        .current-value {
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Expandable Sections */
        .expandable-section {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-toggle {
            width: 100%;
            background: none;
            border: none;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .section-toggle:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .section-toggle.active {
            background: rgba(255, 255, 255, 0.08);
        }

        .toggle-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.1rem;
        }

        .toggle-indicator {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .section-toggle.active .toggle-indicator {
            transform: rotate(180deg);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .section-content.active {
            max-height: 1000px;
        }

        .section-inner {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.03);
        }

        /* Controls */
        .simple-control {
            margin-bottom: 15px;
        }

        .simple-control:last-child {
            margin-bottom: 0;
        }

        .simple-label {
            font-size: 0.8rem;
            margin-bottom: 6px;
            opacity: 0.9;
        }

        .simple-select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.85rem;
        }

        .simple-select option {
            background-color: #2a2a2a;
            color: white;
        }

        .simple-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .simple-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .slider-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Ambient Sound Toggles */
        .ambient-toggles {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .ambient-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 10px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .ambient-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .ambient-toggle.active {
            border-color: #00ffff;
            background: rgba(0, 255, 255, 0.15);
        }

        .ambient-emoji {
            font-size: 1.5rem;
            margin-bottom: 4px;
            display: block;
        }

        .ambient-text {
            font-size: 0.7rem;
            font-weight: 600;
            line-height: 1.2;
        }

        .ambient-settings-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .ambient-toggle.active .ambient-settings-btn {
            display: block;
        }

        .ambient-settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Ambient Settings Panel */
        .ambient-settings-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            border-left: 3px solid #00ffff;
            display: none;
        }

        .ambient-settings-panel.active {
            display: block;
        }

        .ambient-settings-title {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .settings-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 8px;
        }

        .settings-group-title {
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.8;
            text-align: center;
        }

        .mini-control {
            margin-bottom: 8px;
        }

        .mini-control:last-child {
            margin-bottom: 0;
        }

        .mini-label {
            font-size: 0.7rem;
            margin-bottom: 3px;
            opacity: 0.8;
        }

        .mini-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .mini-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .mini-select {
            width: 100%;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.7rem;
        }

        .mini-select option {
            background-color: #2a2a2a;
            color: white;
        }

        .mini-range {
            display: flex;
            justify-content: space-between;
            font-size: 0.6rem;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* Preset Pills */
        .preset-row {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .preset-pill {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .preset-pill:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .preset-pill.active {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
        }

        /* Mini Visualizer */
        .mini-visualizer {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
        }

        .waves-container {
            height: 50px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 8px;
        }

        .wave {
            background-color: rgba(255, 255, 255, 0.4);
            width: 2px;
            height: 20%;
            border-radius: 1px;
            transition: height 0.2s ease;
        }

        .info {
            padding: 10px 20px;
            text-align: center;
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .info a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .info a:hover {
            color: white;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        /* Protection Controls */
        .control-header-with-protection {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .protection-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .enable-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-label {
            font-size: 0.7rem;
            color: #ffc107;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            padding: 3px 6px;
            border-radius: 3px;
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.3);
            transition: all 0.2s ease;
        }

        .checkbox-label:hover {
            background: rgba(255, 193, 7, 0.25);
            border-color: rgba(255, 193, 7, 0.5);
            transform: translateY(-1px);
        }

        .cpu-warning {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 0.7rem;
        }

        .cpu-warning.hidden {
            display: none;
        }

        .warning-icon {
            font-size: 0.9rem;
            margin-top: 1px;
        }

        .warning-text {
            line-height: 1.3;
            color: rgba(255, 255, 255, 0.9);
        }

        .warning-text strong {
            color: #ffc107;
        }

        input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #4a90e2;
            cursor: pointer;
        }

        /* Slots Info */
        .slots-info {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
        }

        .slot-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .slot-info:last-child {
            margin-bottom: 0;
        }

        .slot-info.active {
            border-left-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .slot-info.inactive {
            opacity: 0.6;
            border-left-color: #6b7280;
        }

        .slot-label {
            font-weight: 600;
            color: #e5e7eb;
            min-width: 50px;
        }

        .slot-instrument {
            flex: 1;
            text-align: center;
            color: #d1d5db;
            font-size: 0.75rem;
        }

        .slot-status {
            font-size: 1rem;
            min-width: 20px;
            text-align: center;
        }

        /* Mobile optimizations */
        @media (max-width: 350px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }

            .current-values {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .ambient-toggles {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .ambient-toggle {
                display: flex;
                align-items: center;
                text-align: left;
                gap: 10px;
                padding: 8px 12px;
            }

            .ambient-emoji {
                margin-bottom: 0;
                font-size: 1.3rem;
            }

            .ambient-text {
                flex: 1;
            }

            .ambient-settings-btn {
                position: static;
                margin-left: auto;
            }

            .settings-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        /* Hidden class for disabled sliders */
        input[type="range"]:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        input[type="range"]:disabled::-webkit-slider-thumb {
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>Mood</h1>
        <p>Each composition is unique and evolves over time using generative principles.</p>
    </div>

    <!-- Big Play Button -->
    <div class="big-play-section">
        <button class="big-play-button" id="playBtn">▶️</button>
        <div class="quick-actions">
            <button class="quick-btn" id="dice-button">
                <span>🎲</span> Random
            </button>
            <button class="quick-btn sleep" id="sleepBtn">
                <span id="sleepIcon">😴</span> <span id="sleepText">Sleep</span>
            </button>
        </div>
    </div>

    <!-- Current Settings -->
    <div class="current-settings">
        <div class="current-title">Current Configuration</div>
        <div class="current-values">
            <div class="current-item">
                <div class="current-label">Engine</div>
                <div class="current-value" id="current-engine">Standard</div>
            </div>
            <div class="current-item">
                <div class="current-label">Mood</div>
                <div class="current-value" id="current-mood">Calm</div>
            </div>
            <div class="current-item">
                <div class="current-label">Instrument</div>
                <div class="current-value" id="current-instrument">Piano</div>
            </div>
            <div class="current-item">
                <div class="current-label">Ambient</div>
                <div class="current-value" id="current-ambient">None</div>
            </div>
        </div>
    </div>

    <!-- Presets Section -->
    <div class="expandable-section">
        <button class="section-toggle">
            <div class="toggle-left">
                <span class="section-icon">⭐</span>
                <span>Quick Presets</span>
            </div>
            <span class="toggle-indicator">▼</span>
        </button>
        <div class="section-content">
            <div class="section-inner">
                <div class="preset-row">
                    <div class="preset-pill active" data-preset="classic">1️⃣ Classic</div>
                    <div class="preset-pill" data-preset="evolving">♾️ Evolving</div>
                    <div class="preset-pill" data-preset="minimal-drift">🌱 Minimal</div>
                    <div class="preset-pill" data-preset="puzzle">🧩 Puzzle</div>
                    <div class="preset-pill" data-preset="forest">🌲 Forest</div>
                    <div class="preset-pill" data-preset="frost">❄️ Frost</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Music Section -->
    <div class="expandable-section">
        <button class="section-toggle">
            <div class="toggle-left">
                <span class="section-icon">🎵</span>
                <span>Music & Sound Engine</span>
            </div>
            <span class="toggle-indicator">▼</span>
        </button>
        <div class="section-content">
            <div class="section-inner">
                <div class="simple-control">
                    <div class="simple-label">Sound Engine</div>
                    <select class="simple-select" id="sound-engine">
                        <option value="random">Random (Auto-changing)</option>
                        <option value="standard" selected>Standard Ambient</option>
                        <option value="cathedral-ethereal">Ethereal Cathedral</option>
                        <option value="glacial-ethereal">Glacial Ethereal</option>
                        <option value="dark-matter">Dark Matter</option>
                        <option value="aurora-field">Aurora Field</option>
                        <option value="glass-horizon">Glass Horizon</option>
                        <option value="nebula-drift">Nebula Drift</option>
                        <option value="thermal-layers">Thermal Layers</option>
                        <option value="deep-resonance">Deep Resonance</option>
                        <option value="cosmic-drift">Cosmic Drift</option>
                        <option value="underwater-palace">Underwater Palace</option>
                        <option value="neon-nocturne">Neon Nocturne</option>
                        <option value="atmospheric-temple">Atmospheric Temple</option>
                        <option value="stone-focus">Stone in Focus</option>
                        <option value="string-theory">String Theory</option>
                        <option value="hexagon-sun">Hexagon Sun</option>
                        <option value="parallel-dimension">Parallel Dimension</option>
                        <option value="gentle-rhubarb">Gentle Rhubarb</option>
                        <option value="ethereal-rhubarb">Ethereal Rhubarb</option>
                    </select>
                </div>
                <div class="simple-control">
                    <div class="simple-label">Musical Mood</div>
                    <select class="simple-select" id="mood">
                        <option value="random">Random (Auto-changing)</option>
                        <option value="calm" selected>Calm</option>
                        <option value="ethereal">Ethereal</option>
                        <option value="mysterious">Mysterious</option>
                        <option value="melancholic">Melancholic</option>
                        <option value="hopeful">Hopeful</option>
                        <option value="dreamy">Dreamy</option>
                        <option value="nostalgic">Nostalgic</option>
                        <option value="peaceful">Peaceful</option>
                        <option value="serene">Serene</option>
                    </select>
                </div>
                <div class="simple-control">
                    <div class="simple-label">Note Density</div>
                    <input type="range" class="simple-slider" id="density" min="1" max="10" value="5">
                    <div class="slider-info">
                        <span>Sparse</span>
                        <span>Dense</span>
                    </div>
                </div>
                <div class="simple-control">
                    <div class="simple-label">Reverb Amount</div>
                    <input type="range" class="simple-slider" id="reverb" min="0" max="1" step="0.1" value="0.5">
                    <div class="slider-info">
                        <span>Dry</span>
                        <span>Wet</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Melody Section -->
    <div class="expandable-section">
        <button class="section-toggle">
            <div class="toggle-left">
                <span class="section-icon">🎹</span>
                <span>Melodic Instruments</span>
            </div>
            <span class="toggle-indicator">▼</span>
        </button>
        <div class="section-content">
            <div class="section-inner">
                <div class="simple-control">
                    <div class="simple-label">Melodic Instruments</div>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 0.8rem;">
                        <input type="checkbox" id="melody-toggle" checked>
                        Enable Melodic Instruments
                    </label>
                </div>
                <div class="simple-control">
                    <div class="simple-label">Instrument Selection</div>
                    <select class="simple-select" id="melodic-instrument">
                        <option value="random">Random (Auto-changing)</option>
                        <option value="piano" selected>Soft Piano (All Layers)</option>
                        <option value="rhythmic-piano">Rhythmic Piano (All Layers)</option>
                        <option value="algorithmic-melody">Algorithmic Melody (All Layers)</option>
                        <option value="marimba">Marimba (All Layers)</option>
                        <option value="harp">Harp (All Layers)</option>
                        <option value="music-box">Music Box (All Layers)</option>
                        <option value="glitch-electronic">Glitch Electronic (All Layers)</option>
                        <option value="crystal-bells">Crystal Bells (All Layers)</option>
                        <option value="warm-strings">Warm Strings (All Layers)</option>
                        <option value="ethereal-choir">Ethereal Choir (All Layers)</option>
                        <option value="wind-chimes">Wind Chimes (All Layers)</option>
                        <option value="glass-harmonics">Glass Harmonics (All Layers)</option>
                        <option value="soft-flute">Soft Flute (All Layers)</option>
                        <option value="vintage-celesta">Vintage Celesta (All Layers)</option>
                        <option value="mixed">Mixed (Different Per Layer)</option>
                    </select>
                </div>
                <div class="simple-control">
                    <div class="control-header-with-protection">
                        <div class="simple-label">Number of Melody Layers</div>
                        <div class="protection-controls">
                            <div class="enable-checkbox">
                                <input type="checkbox" id="melody-layers-enable">
                                <label for="melody-layers-enable" class="checkbox-label">Enable Advanced</label>
                            </div>
                        </div>
                    </div>
                    <div class="cpu-warning hidden" id="melody-layers-warning">
                        <div class="warning-icon">⚠️</div>
                        <div class="warning-text">
                            <strong>Warning:</strong> High melody layer counts can cause significant CPU usage.
                        </div>
                    </div>
                    <input type="range" class="simple-slider" id="melody-slot-count" min="1" max="3" value="1" disabled>
                    <div class="slider-info">
                        <span>1 Layer</span>
                        <span>3 Layers</span>
                    </div>
                </div>
                <div class="simple-control">
                    <div class="simple-label">Active Melody Layers</div>
                    <div id="melody-slots-info" class="slots-info">
                        <div class="slot-info active">
                            <span class="slot-label">Layer 1:</span>
                            <span class="slot-instrument">Piano</span>
                            <span class="slot-status">♪</span>
                        </div>
                    </div>
                </div>
                <div class="simple-control">
                    <div class="simple-label">Global Note Frequency</div>
                    <input type="range" class="simple-slider" id="melodic-frequency" min="1" max="10" value="6">
                    <div class="slider-info">
                        <span>Rare</span>
                        <span>Often</span>
                    </div>
                </div>
                <div class="simple-control">
                    <div class="simple-label">Melodic Reverb</div>
                    <input type="range" class="simple-slider" id="melodic-reverb" min="0" max="1" step="0.05" value="0.8">
                    <div class="slider-info">
                        <span>Dry</span>
                        <span>Wet</span>
                    </div>
                </div>
                <div class="simple-control">
                    <div class="simple-label">Layer Randomness</div>
                    <input type="range" class="simple-slider" id="layer-randomness" min="0" max="1" step="0.1" value="0.5">
                    <div class="slider-info">
                        <span>Synchronized</span>
                        <span>Chaotic</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ambient Sounds Section -->
    <div class="expandable-section">
        <button class="section-toggle">
            <div class="toggle-left">
                <span class="section-icon">🌊</span>
                <span>Environmental Sounds</span>
            </div>
            <span class="toggle-indicator">▼</span>
        </button>
        <div class="section-content">
            <div class="section-inner">
                <div class="ambient-toggles">
                    <div class="ambient-toggle" data-sound="waves">
                        <span class="ambient-emoji">🌊</span>
                        <span class="ambient-text">Ocean<br>Waves</span>
                        <button class="ambient-settings-btn">⚙️</button>
                    </div>
                    <div class="ambient-toggle" data-sound="clock">
                        <span class="ambient-emoji">🕰️</span>
                        <span class="ambient-text">Clock<br>Ticking</span>
                        <button class="ambient-settings-btn">⚙️</button>
                    </div>
                    <div class="ambient-toggle" data-sound="thunder">
                        <span class="ambient-emoji">⛈️</span>
                        <span class="ambient-text">Thunder<br>Storm</span>
                        <button class="ambient-settings-btn">⚙️</button>
                    </div>
                </div>

                <!-- Ocean Waves Settings -->
                <div class="ambient-settings-panel" id="waves-settings">
                    <div class="ambient-settings-title">
                        <span>🌊</span> Ocean Waves Configuration
                    </div>
                    <div class="simple-control">
                        <div class="simple-label">Wave Volume</div>
                        <input type="range" class="simple-slider" id="noise-volume" min="-15" max="5" step="1" value="-6">
                        <div class="slider-info">
                            <span>Quiet</span>
                            <span>Loud</span>
                        </div>
                    </div>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <div class="settings-group-title">Wave Character</div>
                            <div class="mini-control">
                                <div class="mini-label">Base Level</div>
                                <input type="range" class="mini-slider" id="base-level" min="0" max="0.3" step="0.01" value="0.05">
                                <div class="mini-range">
                                    <span>Silent</span>
                                    <span>Audible</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Peak Level</div>
                                <input type="range" class="mini-slider" id="peak-level" min="0.1" max="0.8" step="0.01" value="0.4">
                                <div class="mini-range">
                                    <span>Gentle</span>
                                    <span>Powerful</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Build Speed</div>
                                <input type="range" class="mini-slider" id="build-speed" min="0.5" max="5" step="0.1" value="2">
                                <div class="mini-range">
                                    <span>Slow</span>
                                    <span>Fast</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Noise Type</div>
                                <select class="mini-select" id="noise-type">
                                    <option value="white">White</option>
                                    <option value="pink" selected>Pink</option>
                                    <option value="brown">Brown</option>
                                </select>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="settings-group-title">Timing & Filter</div>
                            <div class="mini-control">
                                <div class="mini-label">Min Duration</div>
                                <input type="range" class="mini-slider" id="min-duration" min="2" max="15" step="0.5" value="4">
                                <div class="mini-range">
                                    <span>2s</span>
                                    <span>15s</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Max Duration</div>
                                <input type="range" class="mini-slider" id="max-duration" min="5" max="25" step="0.5" value="12">
                                <div class="mini-range">
                                    <span>5s</span>
                                    <span>25s</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Pause Between</div>
                                <input type="range" class="mini-slider" id="pause-between" min="0.5" max="8" step="0.25" value="2">
                                <div class="mini-range">
                                    <span>0.5s</span>
                                    <span>8s</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Filter Frequency</div>
                                <input type="range" class="mini-slider" id="filter-freq" min="200" max="8000" step="50" value="2000">
                                <div class="mini-range">
                                    <span>200Hz</span>
                                    <span>8kHz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clock Settings -->
                <div class="ambient-settings-panel" id="clock-settings">
                    <div class="ambient-settings-title">
                        <span>🕰️</span> Grandfather Clock Configuration
                    </div>
                    <div class="simple-control">
                        <div class="simple-label">Clock Volume</div>
                        <input type="range" class="simple-slider" id="clock-volume" min="-20" max="0" step="1" value="-6">
                        <div class="slider-info">
                            <span>Quiet</span>
                            <span>Loud</span>
                        </div>
                    </div>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <div class="settings-group-title">Clock Character</div>
                            <div class="mini-control">
                                <div class="mini-label">Tempo (BPM)</div>
                                <input type="range" class="mini-slider" id="clock-tempo" min="30" max="120" step="1" value="60">
                                <div class="mini-range">
                                    <span>30</span>
                                    <span>120</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Tick Brightness</div>
                                <input type="range" class="mini-slider" id="clock-brightness" min="800" max="4000" step="50" value="2000">
                                <div class="mini-range">
                                    <span>Warm</span>
                                    <span>Bright</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Wood Resonance</div>
                                <input type="range" class="mini-slider" id="clock-resonance" min="0.5" max="15" step="0.5" value="8">
                                <div class="mini-range">
                                    <span>Muted</span>
                                    <span>Resonant</span>
                                </div>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="settings-group-title">Ambient Processing</div>
                            <div class="mini-control">
                                <div class="mini-label">Reverb Amount</div>
                                <input type="range" class="mini-slider" id="clock-reverb" min="0" max="1" step="0.05" value="0.8">
                                <div class="mini-range">
                                    <span>Dry</span>
                                    <span>Wet</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Reverb Decay</div>
                                <input type="range" class="mini-slider" id="clock-decay" min="5" max="40" step="1" value="25">
                                <div class="mini-range">
                                    <span>5s</span>
                                    <span>40s</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Current Tempo</div>
                                <div id="clock-tempo-display" style="background: rgba(139, 69, 19, 0.3); border-radius: 4px; padding: 4px 6px; text-align: center; font-size: 0.7rem; color: #FFD700; border: 1px solid rgba(255, 215, 0, 0.3);">
                                    60 BPM
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thunder Settings -->
                <div class="ambient-settings-panel" id="thunder-settings">
                    <div class="ambient-settings-title">
                        <span>⛈️</span> Thunder Storm Configuration
                    </div>
                    <div class="simple-control">
                        <div class="simple-label">Storm Volume</div>
                        <input type="range" class="simple-slider" id="thunder-volume" min="-20" max="0" step="1" value="0">
                        <div class="slider-info">
                            <span>Quiet</span>
                            <span>Loud</span>
                        </div>
                    </div>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <div class="settings-group-title">Thunder Settings</div>
                            <div class="mini-control">
                                <div class="mini-label">Thunder Intensity</div>
                                <input type="range" class="mini-slider" id="thunder-intensity" min="0.3" max="1.0" step="0.1" value="0.7">
                                <div class="mini-range">
                                    <span>Gentle</span>
                                    <span>Powerful</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Thunder Distance</div>
                                <input type="range" class="mini-slider" id="thunder-distance" min="0.1" max="1.0" step="0.1" value="0.5">
                                <div class="mini-range">
                                    <span>Close</span>
                                    <span>Distant</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Thunder Frequency</div>
                                <input type="range" class="mini-slider" id="thunder-frequency" min="2" max="15" step="1" value="8">
                                <div class="mini-range">
                                    <span>Frequent</span>
                                    <span>Rare</span>
                                </div>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="settings-group-title">Rain Settings</div>
                            <div class="mini-control">
                                <div class="mini-label">Rain Volume</div>
                                <input type="range" class="mini-slider" id="thunder-rain-volume" min="0.1" max="0.4" step="0.05" value="0.2">
                                <div class="mini-range">
                                    <span>Light</span>
                                    <span>Heavy</span>
                                </div>
                            </div>
                            <div class="mini-control">
                                <div class="mini-label">Rain Type</div>
                                <select class="mini-select">
                                    <option>Light Drizzle</option>
                                    <option selected>Steady Rain</option>
                                    <option>Heavy Downpour</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Section -->
    <div class="expandable-section">
        <button class="section-toggle">
            <div class="toggle-left">
                <span class="section-icon">⚙️</span>
                <span>Audio Settings</span>
            </div>
            <span class="toggle-indicator">▼</span>
        </button>
        <div class="section-content">
            <div class="section-inner">
                <div class="simple-control">
                    <div class="simple-label">Master Volume</div>
                    <input type="range" class="simple-slider" id="volume" min="-30" max="0" step="1" value="-15">
                    <div class="slider-info">
                        <span>🔇 Quiet</span>
                        <span>Loud 🔊</span>
                    </div>
                </div>
                <div class="simple-control">
                    <div class="simple-label">Random Change Interval</div>
                    <input type="range" class="simple-slider" id="random-interval" min="1" max="30" step="1" value="10">
                    <div class="slider-info">
                        <span>1 min</span>
                        <span>30 min</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mini Visualizer -->
    <div class="mini-visualizer">
        <div class="waves-container" id="waves">
            <!-- Waves will be created by JavaScript -->
        </div>
    </div>

    <div class="info">
        <p>By <a href="https://github.com/mrbarge/mood">mrbarge</a>, with ❤️ to <a href="https://tonejs.github.io/">tone.js</a></p>
    </div>
</div>

<script>
    // Global variables (same as original)
    let musicManager = null;
    let melodyManager = null;
    let waveManager = null;
    let clockManager = null;
    let sleepManager = null;
    let thunderManager = null;
    let presetManager = null;
    let clockInitialized = false;
    let isPlaying = false;
    let activeNotes = {};
    let currentActiveMood = "calm";
    let visualizerInterval = null;

    // Create audio context and effects (same as original)
    const masterVolume = new Tone.Volume(-15).toDestination();
    const reverb = new Tone.Reverb({
        decay: 10,
        wet: 0.5,
        preDelay: 0.01
    }).connect(masterVolume);

    const delay = new Tone.FeedbackDelay({
        delayTime: "8n",
        feedback: 0.4,
        wet: 0.3
    }).connect(reverb);

    const filter = new Tone.Filter({
        type: "lowpass",
        frequency: 2000,
        Q: 1
    }).connect(delay);

    // Element references
    const playBtn = document.getElementById('playBtn');
    const sleepBtn = document.getElementById('sleepBtn');
    const diceButton = document.getElementById('dice-button');

    // Scale definitions (same as original)
    const scales = {
        calm: ["C3", "D3", "E3", "G3", "A3", "C4", "D4", "E4", "G4", "A4", "C5"],
        ethereal: ["D3", "F#3", "A3", "B3", "D4", "F#4", "A4", "B4", "D5"],
        mysterious: ["C3", "D#3", "F3", "G#3", "B3", "C4", "D#4", "F4", "G#4", "B4"],
        melancholic: ["A2", "C3", "D3", "E3", "F3", "A3", "C4", "D4", "E4", "F4", "A4"],
        hopeful: ["G3", "A3", "B3", "D4", "E4", "G4", "A4", "B4", "D5", "E5"],
        dreamy: ["C3", "D3", "E3", "F#3", "G3", "A3", "B3", "C4", "D4", "E4", "F#4", "G4", "A4", "B4", "C5"],
        nostalgic: ["A2", "B2", "C3", "D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4"],
        peaceful: ["D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5"],
        serene: ["C3", "D3", "E3", "G3", "A3", "C4", "D4", "E4", "G4", "A4", "C5", "D5", "E5", "G5"]
    };

    const melodicPatterns = {
        calm: ["E4", "G4", "C5"],
        ethereal: ["F#4", "B4", "D5"],
        mysterious: ["D#4", "G#4", "C5"],
        melancholic: ["C4", "E4", "A4"],
        hopeful: ["B4", "D5", "G4"],
        dreamy: ["E4", "F#4", "A4", "B4"],
        nostalgic: ["C4", "E4", "F4", "A4"],
        peaceful: ["D4", "F4", "A4", "C5"],
        serene: ["E4", "G4", "C5"]
    };

    // UI Functions
    function updateCurrentSettings() {
        // Update engine
        const soundEngine = document.getElementById('sound-engine');
        const engineText = soundEngine.selectedOptions[0].text;
        document.getElementById('current-engine').textContent = engineText.includes('Random') ? 'Random' : engineText.split(' ')[0];

        // Update mood
        const mood = document.getElementById('mood');
        const moodText = mood.selectedOptions[0].text;
        document.getElementById('current-mood').textContent = moodText.includes('Random') ? 'Random' : moodText;

        // Update instrument
        const instrument = document.getElementById('melodic-instrument');
        let instrumentText = 'None';
        if (document.getElementById('melody-toggle').checked) {
            instrumentText = instrument.selectedOptions[0].text.includes('Random') ? 'Random' :
                instrument.selectedOptions[0].text.split(' ')[0];
        }
        document.getElementById('current-instrument').textContent = instrumentText;

        // Update ambient
        const activeAmbient = Array.from(document.querySelectorAll('.ambient-toggle.active'))
            .map(toggle => toggle.querySelector('.ambient-text').textContent.split('\n')[0])
            .join(', ');
        document.getElementById('current-ambient').textContent = activeAmbient || 'None';
    }

    function updatePlayButton(playing) {
        if (playing) {
            playBtn.innerHTML = '⏹️';
            playBtn.classList.add('stop');
        } else {
            playBtn.innerHTML = '▶️';
            playBtn.classList.remove('stop');
        }
    }

    // Section toggle functionality
    document.querySelectorAll('.section-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const content = toggle.nextElementSibling;
            const isActive = toggle.classList.contains('active');

            // Close all sections
            document.querySelectorAll('.section-toggle').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section-content').forEach(c => c.classList.remove('active'));

            // Open clicked section if it wasn't active
            if (!isActive) {
                toggle.classList.add('active');
                content.classList.add('active');
            }
        });
    });

    // Preset selection
    document.querySelectorAll('.preset-pill').forEach(pill => {
        pill.addEventListener('click', () => {
            document.querySelectorAll('.preset-pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            updateCurrentSettings();
        });
    });

    // Ambient toggles and settings
    document.querySelectorAll('.ambient-toggle').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            // Don't trigger toggle if clicking settings button
            if (e.target.classList.contains('ambient-settings-btn')) {
                e.stopPropagation();
                const soundType = toggle.dataset.sound;
                const settingsPanel = document.getElementById(`${soundType}-settings`);

                // Hide all other settings panels
                document.querySelectorAll('.ambient-settings-panel').forEach(panel => {
                    if (panel !== settingsPanel) {
                        panel.classList.remove('active');
                    }
                });

                // Toggle this settings panel
                settingsPanel.classList.toggle('active');
                return;
            }

            // Normal toggle functionality
            const wasActive = toggle.classList.contains('active');
            toggle.classList.toggle('active');

            // Handle the actual audio toggle
            const soundType = toggle.dataset.sound;
            if (soundType === 'waves') {
                // document.getElementById('noise-toggle').checked = !wasActive;
                console.log("hdasdfasdf");
                if (waveManager) waveManager.toggle();
            } else if (soundType === 'clock') {
                // document.getElementById('clock-toggle').checked = !wasActive;
                if (clockManager) clockManager.toggle();
            } else if (soundType === 'thunder') {
                // document.getElementById('thunder-toggle').checked = !wasActive;
                if (thunderManager) thunderManager.toggle();
            }

            // Hide settings panel if sound is turned off
            if (wasActive) {
                const settingsPanel = document.getElementById(`${soundType}-settings`);
                settingsPanel.classList.remove('active');
            }

            updateCurrentSettings();
        });
    });

    // Advanced melody layers control
    document.getElementById('melody-layers-enable').addEventListener('change', function() {
        const slider = document.getElementById('melody-slot-count');
        const warning = document.getElementById('melody-layers-warning');

        slider.disabled = !this.checked;
        if (this.checked) {
            warning.classList.remove('hidden');
        } else {
            warning.classList.add('hidden');
            slider.value = '1';
        }
    });

    // Clock tempo display update
    document.getElementById('clock-tempo').addEventListener('input', function() {
        document.getElementById('clock-tempo-display').textContent = `${this.value} BPM`;
    });

    // Update current settings when controls change
    document.getElementById('sound-engine').addEventListener('change', updateCurrentSettings);
    document.getElementById('mood').addEventListener('change', updateCurrentSettings);
    document.getElementById('melodic-instrument').addEventListener('change', updateCurrentSettings);
    document.getElementById('melody-toggle').addEventListener('change', updateCurrentSettings);

    // Main play button
    playBtn.addEventListener('click', () => {
        if (isPlaying) {
            stopMusic();
            updatePlayButton(false);
        } else {
            startMusic();
            updatePlayButton(true);
        }
    });

    // Sleep button
    sleepBtn.addEventListener('click', () => {
        if (sleepManager) {
            sleepManager.toggle();
            sleepBtn.classList.toggle('active');
            const icon = document.getElementById('sleepIcon');
            const text = document.getElementById('sleepText');
            if (sleepBtn.classList.contains('active')) {
                icon.textContent = '😴';
                text.textContent = 'Wake';
            } else {
                icon.textContent = '😴';
                text.textContent = 'Sleep';
            }
        }
    });

    // Wave animation
    function animateWaves() {
        document.querySelectorAll('.wave').forEach((wave, index) => {
            const height = Math.random() * 60 + 20;
            wave.style.height = height + '%';
        });
    }

    function startVisualizer() {
        if (visualizerInterval) clearInterval(visualizerInterval);
        visualizerInterval = setInterval(animateWaves, 300);
        animateWaves();
    }

    // Music functions (adapted from original)
    async function startMusic() {
        if (isPlaying) return;

        console.log('🎵 Starting ambient music system...');

        try {
            await Tone.start();
            isPlaying = true;
            activeNotes = {};

            // Initialize managers if needed
            if (!musicManager) musicManager = new AmbientMusicManager();
            if (!melodyManager) melodyManager = new MultiMelodyManager();
            if (!waveManager) waveManager = new OceanWaveManager();
            if (!clockManager) clockManager = new GrandfatherClockManager();
            if (!sleepManager) sleepManager = new SleepModeManager();
            if (!thunderManager) thunderManager = new ThunderStormManager();

            // Set up sound engine
            const soundEngineSelect = document.getElementById('sound-engine');
            const selectedEngine = soundEngineSelect.value;

            if (selectedEngine !== "random") {
                await musicManager.setSoundEngine(selectedEngine, {
                    density: parseInt(document.getElementById('density').value),
                    reverbAmount: parseFloat(document.getElementById('reverb').value)
                });
            } else {
                const availableEngines = musicManager.getAvailableSoundEngines();
                const randomEngine = availableEngines[Math.floor(Math.random() * availableEngines.length)];
                await musicManager.setSoundEngine(randomEngine.key, {
                    density: parseInt(document.getElementById('density').value),
                    reverbAmount: parseFloat(document.getElementById('reverb').value)
                });
            }

            // Set mood
            const moodSelect = document.getElementById('mood');
            if (moodSelect.value !== "random") {
                currentActiveMood = moodSelect.value;
            } else {
                const availableMoods = musicManager.getAvailableMoods();
                currentActiveMood = availableMoods[Math.floor(Math.random() * availableMoods.length)];
            }
            musicManager.setMood(currentActiveMood);

            // Start random cycles if needed
            if (moodSelect.value === "random") {
                musicManager.startRandomMoodCycle();
            }
            if (soundEngineSelect.value === "random") {
                musicManager.startRandomEngineCycle();
            }

            // Update audio settings
            reverb.wet.value = parseFloat(document.getElementById('reverb').value);
            masterVolume.volume.value = parseInt(document.getElementById('volume').value);

            Tone.Transport.bpm.value = 60;
            Tone.Transport.start();

            await musicManager.start();

            // Handle melody
            const melodyToggle = document.getElementById('melody-toggle');
            if (melodyToggle.checked && melodyManager) {
                if (melodyManager.getCurrentSlotCount() === 0) {
                    melodyManager.initializeSlots(1);
                }

                const selectedInstrument = document.getElementById('melodic-instrument').value;
                if (selectedInstrument !== "random") {
                    await melodyManager.setAllSlotsToInstrument(selectedInstrument, {
                        reverbAmount: parseFloat(document.getElementById('melodic-reverb').value)
                    });
                }

                const currentScale = scales[currentActiveMood];
                const melodicPattern = melodicPatterns[currentActiveMood];
                if (currentScale && melodicPattern) {
                    await melodyManager.start(currentScale, melodicPattern);
                }
            }

            // Handle ambient sounds
            document.querySelectorAll('.ambient-toggle.active').forEach(toggle => {
                const soundType = toggle.dataset.sound;
                if (soundType === 'waves' && waveManager) {
                    waveManager.toggle();
                } else if (soundType === 'clock' && clockManager) {
                    clockManager.toggle();
                } else if (soundType === 'thunder' && thunderManager) {
                    thunderManager.toggle();
                }
            });

            startVisualizer();
            console.log('✅ Music started successfully!');

        } catch (error) {
            console.error('❌ Error starting music:', error);
            isPlaying = false;
        }
    }

    function stopMusic() {
        console.log('🛑 Stopping ambient music system...');
        isPlaying = false;

        if (musicManager) musicManager.stop();
        if (melodyManager) melodyManager.stop();
        if (waveManager && document.querySelector('.ambient-toggle[data-sound="waves"]').classList.contains('active')) {
            waveManager.toggle();
        }
        if (clockManager && document.querySelector('.ambient-toggle[data-sound="clock"]').classList.contains('active')) {
            console.log("Stopping clock");

            clockManager.toggle();
        }
        if (thunderManager && document.querySelector('.ambient-toggle[data-sound="thunder"]').classList.contains('active')) {
            thunderManager.toggle();
        }

        Tone.Transport.stop();

        if (visualizerInterval) {
            clearInterval(visualizerInterval);
            visualizerInterval = null;
        }

        activeNotes = {};
        console.log("✅ Music stopped successfully");
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🎵 Initializing Mood App...');

        // Initialize managers
        melodyManager = new MultiMelodyManager();
        melodyManager.initializeSlots(1);

        const melodyToggle = document.getElementById('melody-toggle');
        if (melodyToggle) {
            // Set initial state based on checkbox
            melodyManager.setEnabled(melodyToggle.checked);

            // Listen for changes
            melodyToggle.addEventListener('change', async function() {
                melodyManager.setEnabled(this.checked);
                console.log(`🎵 Melody manager ${this.checked ? 'enabled' : 'disabled'}`);

                if (this.checked && isPlaying) {
                    // When re-enabling, restart the melody if music is currently playing
                    try {
                        // Make sure we have slots initialized
                        if (melodyManager.getCurrentSlotCount() === 0) {
                            melodyManager.initializeSlots(1);
                        }

                        // Set the current instrument
                        const selectedInstrument = document.getElementById('melodic-instrument').value;
                        if (selectedInstrument !== "random") {
                            await melodyManager.setAllSlotsToInstrument(selectedInstrument, {
                                reverbAmount: parseFloat(document.getElementById('melodic-reverb').value || 0.8)
                            });
                        } else {
                            await melodyManager.randomizeSlotInstruments();
                        }

                        // Start melody with current scale and pattern
                        const currentMood = typeof currentActiveMood !== 'undefined' ? currentActiveMood :
                            (document.getElementById('mood').value === 'random' ? 'calm' : document.getElementById('mood').value);

                        if (scales[currentMood] && melodicPatterns[currentMood]) {
                            await melodyManager.start(scales[currentMood], melodicPatterns[currentMood]);
                        }

                        console.log('🎵 Melody restarted after re-enabling');
                    } catch (error) {
                        console.error('🎵 Error restarting melody:', error);
                    }
                }

                // Update current settings display
                updateCurrentSettings();
            });
        }

        const melodicInstrumentSelect = document.getElementById('melodic-instrument');
        if (melodicInstrumentSelect) {
            melodicInstrumentSelect.addEventListener('change', async function() {
                if (melodyManager && melodyManager.isEnabled && isPlaying) {
                    console.log(`🎵 Changing instrument to: ${this.value}`);

                    try {
                        // Set the new instrument
                        if (this.value !== "random") {
                            await melodyManager.setAllSlotsToInstrument(this.value, {
                                reverbAmount: parseFloat(document.getElementById('melodic-reverb').value || 0.8)
                            });
                        } else {
                            // Handle random selection
                            await melodyManager.randomizeSlotInstruments();
                            melodyManager.startRandomCycle();
                        }

                        // Restart melody with current scale and pattern
                        const currentMood = typeof currentActiveMood !== 'undefined' ? currentActiveMood :
                            (document.getElementById('mood').value === 'random' ? 'calm' : document.getElementById('mood').value);

                        if (scales[currentMood] && melodicPatterns[currentMood]) {
                            await melodyManager.start(scales[currentMood], melodicPatterns[currentMood]);
                        }

                        updateCurrentSettings();
                    } catch (error) {
                        console.error('🎵 Error changing instrument:', error);
                    }
                }
            });
        }

        // Create wave elements for visualizer
        const wavesContainer = document.getElementById('waves');
        for (let i = 0; i < 20; i++) {
            const wave = document.createElement("div");
            wave.className = "wave";
            wavesContainer.appendChild(wave);
        }

        // Initialize preset manager
        if (typeof PresetManager !== 'undefined') {
            presetManager = new PresetManager();
        }

        updateCurrentSettings();
        console.log('✅ Mood App initialized successfully');
    });

    // Dice randomizer (same logic as original)
    diceButton.addEventListener('click', function() {
        console.log('🎲 Starting randomization...');

        this.style.transform = 'scale(0.95)';
        this.innerHTML = '<span>🎲</span> Rolling...';

        setTimeout(() => {
            // Randomize all the things...
            const moodSelect = document.getElementById('mood');
            const moodOptions = Array.from(moodSelect.options).filter(option => option.value !== 'random');
            const randomMood = moodOptions[Math.floor(Math.random() * moodOptions.length)];
            moodSelect.value = randomMood.value;

            const soundEngineSelect = document.getElementById('sound-engine');
            const engineOptions = Array.from(soundEngineSelect.options).filter(option => option.value !== 'random');
            const randomEngine = engineOptions[Math.floor(Math.random() * engineOptions.length)];
            soundEngineSelect.value = randomEngine.value;

            const instrumentSelect = document.getElementById('melodic-instrument');
            const instrumentOptions = Array.from(instrumentSelect.options).filter(option => option.value !== 'random');
            const randomInstrument = instrumentOptions[Math.floor(Math.random() * instrumentOptions.length)];
            instrumentSelect.value = randomInstrument.value;

            // Randomize ambient sounds
            document.querySelectorAll('.ambient-toggle').forEach(toggle => {
                if (Math.random() > 0.6) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            });

            // Randomize sliders
            document.getElementById('density').value = Math.floor(Math.random() * 8) + 2;
            document.getElementById('reverb').value = (Math.random() * 0.8 + 0.2).toFixed(1);
            document.getElementById('melodic-frequency').value = Math.floor(Math.random() * 8) + 2;
            document.getElementById('melodic-reverb').value = (Math.random() * 0.6 + 0.4).toFixed(2);

            updateCurrentSettings();

            // Reset button
            this.style.transform = 'scale(1)';
            this.innerHTML = '<span>🎲</span> Random';

            console.log('✅ Randomization complete!');
        }, 800);
    });
</script>
</body>
</html>