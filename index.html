<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="js/audio-chain-system.js"></script>
    <script src="js/melody-instruments.js"></script>
    <script src="js/multi-melody-system.js"></script>
    <script src="js/sound-engines.js"></script>
    <script src="js/ocean-waves.js"></script>
    <script src="js/grandfather-clock.js"></script>
    <script src="js/sleep-manager.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1 class="mood-header">Mood</h1>
        <p>Each composition is unique and evolves over time using generative principles.</p>
    </div>

    <div class="main-controls">

        <!-- Dice Randomizer -->
        <div class="dice-section">
            <button class="dice-button" id="dice-button" title="Randomizes mood, sound engine, melody instrument, wave settings, and sliders">
                <span class="dice-icon">üé≤</span>
                Randomize Everything
            </button>
        </div>

        <!-- Mood Section -->
        <div class="control-section" id="mood-section">
            <div class="section-header" onclick="toggleSection('mood')">
                <div class="section-title">
                    <div class="section-icon mood-icon">üé≠</div>
                    <div>
                        <div class="section-info">Mood & Engine</div>
                        <div class="section-status">
                            <span id="mood-status">Calm</span> ‚Ä¢
                            <span id="sound-engine-status">Standard Ambient</span>
                        </div>
                    </div>
                </div>
                <button class="expand-btn" id="mood-expand">
                    <span>‚ñº</span>
                </button>
            </div>
            <div class="section-content" id="mood-content">
                <!-- Updated Sound Engine Control with Random Option -->
                <div class="control-group">
                    <label class="control-label" for="sound-engine">Sound Engine</label>
                    <select id="sound-engine" onchange="handleSoundEngineChange()">
                        <option value="random">Random (Auto-changing)</option>
                        <option value="standard" selected>Standard Ambient</option>
                        <option value="cathedral-ethereal">Ethereal Cathedral</option>
                        <option value="glacial-ethereal">Glacial Ethereal</option>
                        <option value="dark-matter">Dark Matter</option>
                        <option value="aurora-field">Aurora Field</option>
                        <option value="glass-horizon">Glass Horizon</option>
                        <option value="nebula-drift">Nebula Drift</option>
                        <option value="thermal-layers">Thermal Layers</option>
                        <option value="deep-resonance">Deep Resonance</option>
                        <option value="cosmic-drift">Cosmic Drift</option>
                        <option value="underwater-palace">Underwater Palace</option>
                        <option value="neon-nocturne">Neon Nocturne</option>
                        <option value="atmospheric-temple">Atmospheric Temple</option>
                        <option value="stone-focus">Stone in Focus</option>
                        <option value="string-theory">String Theory</option>
                        <option value="hexagon-sun">Hexagon Sun</option>
                        <option value="parallel-dimension">Parallel Dimension</option>
                        <option value="gentle-rhubarb">Gentle Rhubarb</option>
                        <option value="ethereal-rhubarb">Ethereal Rhubarb</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label" for="mood">Musical Mood</label>
                    <select id="mood" onchange="updateMoodStatus()">
                        <option value="random">Random (Auto-changing)</option>
                        <option value="calm" selected>Calm</option>
                        <option value="ethereal">Ethereal</option>
                        <option value="mysterious">Mysterious</option>
                        <option value="melancholic">Melancholic</option>
                        <option value="hopeful">Hopeful</option>
                        <option value="dreamy">Dreamy</option>
                        <option value="nostalgic">Nostalgic</option>
                        <option value="peaceful">Peaceful</option>
                        <option value="serene">Serene</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label" for="density">Note Density</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="density" min="1" max="10" value="5">
                        </div>
                        <div class="slider-labels">
                            <span>Sparse</span>
                            <span>Dense</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="reverb">Reverb Amount</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="reverb" min="0" max="1" step="0.1" value="0.5">
                        </div>
                        <div class="slider-labels">
                            <span>Dry</span>
                            <span>Wet</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Melody Section -->
        <div class="control-section" id="melody-section">
            <div class="section-header" onclick="toggleSection('melody')">
                <div class="section-title">
                    <div class="toggle-btn" onclick="toggleMelody(event)">
                        <input type="checkbox" id="melody-toggle" onchange="updateMelodyStatus()" onclick="event.stopPropagation()">
                        <span class="toggle-indicator"></span>
                    </div>
                    <div class="section-icon melody-icon">üéπ</div>
                    <div>
                        <div class="section-info">Melodic Instruments</div>
                        <div class="section-status" id="melody-status">1 Layer: Soft Piano</div>
                    </div>
                </div>
                <button class="expand-btn" id="melody-expand">
                    <span>‚ñº</span>
                </button>
            </div>
            <div class="section-content" id="melody-content">
                <div class="control-group">
                    <label class="control-label" for="melodic-instrument">Instrument Selection</label>
                    <select id="melodic-instrument" onchange="updateMelodyStatus()">
                        <option value="random">Random (Auto-changing)</option>
                        <option value="piano" selected>Soft Piano (All Layers)</option>
                        <option value="rhythmic-piano">Rhythmic Piano (All Layers)</option> <!-- NEW OPTION -->
                        <option value="marimba">Marimba (All Layers)</option>
                        <option value="harp">Harp (All Layers)</option>
                        <option value="music-box">Music Box (All Layers)</option>
                        <option value="glitch-electronic">Glitch Electronic (All Layers)</option>
                        <option value="crystal-bells">Crystal Bells (All Layers)</option>
                        <option value="warm-strings">Warm Strings (All Layers)</option>
                        <option value="ethereal-choir">Ethereal Choir (All Layers)</option>
                        <option value="wind-chimes">Wind Chimes (All Layers)</option>
                        <option value="glass-harmonics">Glass Harmonics (All Layers)</option>
                        <option value="soft-flute">Soft Flute (All Layers)</option>
                        <option value="vintage-celesta">Vintage Celesta (All Layers)</option>
                        <option value="mixed">Mixed (Different Per Layer)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label" for="melody-slot-count">Number of Melody Layers</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="melody-slot-count" min="1" max="3" value="1" onchange="handleSlotCountChange()">
                        </div>
                        <div class="slider-labels">
                            <span>1 Layer</span>
                            <span>3 Layers</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Active Melody Layers</label>
                    <div id="melody-slots-info" class="slots-info">
                        <div class="slot-info active">
                            <span class="slot-label">Layer 1:</span>
                            <span class="slot-instrument">Piano</span>
                            <span class="slot-status">‚ô™</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="melodic-frequency">Global Note Frequency</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="melodic-frequency" min="1" max="10" value="6">
                        </div>
                        <div class="slider-labels">
                            <span>Rare</span>
                            <span>Often</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="melodic-reverb">Melodic Reverb</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="melodic-reverb" min="0" max="1" step="0.05" value="0.8">
                        </div>
                        <div class="slider-labels">
                            <span>Dry</span>
                            <span>Wet</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="layer-randomness">Layer Randomness</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="layer-randomness" min="0" max="1" step="0.1" value="0.5">
                        </div>
                        <div class="slider-labels">
                            <span>Synchronized</span>
                            <span>Chaotic</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ocean Waves Section -->
        <div class="control-section" id="waves-section">
            <div class="section-header" onclick="toggleSection('waves')">
                <div class="section-title">
                    <div class="toggle-btn" onclick="toggleWaves()">
                        <input type="checkbox" id="noise-toggle" onchange="updateWavesStatus()" onclick="event.stopPropagation()">
                        <span class="toggle-indicator"></span>
                    </div>
                    <div class="section-icon waves-icon">üåä</div>
                    <div>
                        <div class="section-info">Ocean Waves</div>
                        <div class="section-status" id="waves-status">Off</div>
                    </div>
                </div>
                <button class="expand-btn" id="waves-expand">
                    <span>‚ñº</span>
                </button>
            </div>

            <div class="section-content" id="waves-content">
                <!-- Single column controls -->
                <div class="control-group">
                    <label class="control-label" for="noise-volume">Wave Volume</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="noise-volume" min="-15" max="5" step="1" value="-6">
                        </div>
                        <div class="slider-labels">
                            <span>Quiet</span>
                            <span>Loud</span>
                        </div>
                    </div>
                </div>

                <!-- Two-column layout for detailed controls -->
                <div class="waves-grid">
                    <!-- Left column - Wave Characteristics -->
                    <div class="waves-column">
                        <h4 class="column-header">Wave Characteristics</h4>

                        <div class="control-group">
                            <label class="control-label" for="base-level">Base Level</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="base-level" min="0" max="0.3" step="0.01" value="0.05">
                                </div>
                                <div class="slider-labels">
                                    <span>Silent</span>
                                    <span>Audible</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="peak-level">Peak Level</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="peak-level" min="0.1" max="0.8" step="0.01" value="0.4">
                                </div>
                                <div class="slider-labels">
                                    <span>Gentle</span>
                                    <span>Powerful</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="build-speed">Build Speed</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="build-speed" min="0.5" max="5" step="0.1" value="2">
                                </div>
                                <div class="slider-labels">
                                    <span>Slow</span>
                                    <span>Fast</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="noise-type">Noise Type</label>
                            <select id="noise-type">
                                <option value="white">White (Bright)</option>
                                <option value="pink" selected>Pink (Natural)</option>
                                <option value="brown">Brown (Deep)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Right column - Timing & Filter -->
                    <div class="waves-column">
                        <h4 class="column-header">Timing & Filter</h4>

                        <div class="control-group">
                            <label class="control-label" for="min-duration">Min Duration (s)</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="min-duration" min="2" max="15" step="0.5" value="4">
                                </div>
                                <div class="slider-labels">
                                    <span>2s</span>
                                    <span>15s</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="max-duration">Max Duration (s)</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="max-duration" min="5" max="25" step="0.5" value="12">
                                </div>
                                <div class="slider-labels">
                                    <span>5s</span>
                                    <span>25s</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="pause-between">Pause Between (s)</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="pause-between" min="0.5" max="8" step="0.25" value="2">
                                </div>
                                <div class="slider-labels">
                                    <span>0.5s</span>
                                    <span>8s</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="filter-freq">Filter Frequency</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="filter-freq" min="200" max="8000" step="50" value="2000">
                                </div>
                                <div class="slider-labels">
                                    <span>200 Hz</span>
                                    <span>8000 Hz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grandfather Clock Section -->
        <div class="control-section" id="clock-section">
            <div class="section-header" onclick="toggleSection('clock')">
                <div class="section-title">
                    <div class="toggle-btn">
                        <input type="checkbox" id="clock-toggle" onchange="updateClockStatus(); toggleClock();">
                        <span class="toggle-indicator"></span>
                    </div>
                    <div class="section-icon clock-icon">üï∞Ô∏è</div>
                    <div>
                        <div class="section-info">Grandfather Clock</div>
                        <div class="section-status" id="clock-status">Off</div>
                    </div>
                </div>
                <button class="expand-btn" id="clock-expand">
                    <span>‚ñº</span>
                </button>
            </div>

            <div class="section-content" id="clock-content">
                <div class="control-group">
                    <label class="control-label" for="clock-volume">Clock Volume</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="clock-volume" min="-20" max="0" step="1" value="-6">
                        </div>
                        <div class="slider-labels">
                            <span>Quiet</span>
                            <span>Loud</span>
                        </div>
                    </div>
                </div>

                <div class="clock-grid">
                    <div class="clock-column">
                        <h4 class="column-header">Clock Characteristics</h4>

                        <div class="control-group">
                            <label class="control-label" for="clock-tempo">Tempo (BPM)</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="clock-tempo" min="30" max="120" step="1" value="60">
                                </div>
                                <div class="slider-labels">
                                    <span>30</span>
                                    <span>120</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="clock-brightness">Tick Brightness</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="clock-brightness" min="800" max="4000" step="50" value="2000">
                                </div>
                                <div class="slider-labels">
                                    <span>Warm</span>
                                    <span>Bright</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="clock-resonance">Wood Resonance</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="clock-resonance" min="0.5" max="15" step="0.5" value="8">
                                </div>
                                <div class="slider-labels">
                                    <span>Muted</span>
                                    <span>Resonant</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="clock-column">
                        <h4 class="column-header">Ambient Processing</h4>

                        <div class="control-group">
                            <label class="control-label" for="clock-reverb">Reverb Amount</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="clock-reverb" min="0" max="1" step="0.05" value="0.8">
                                </div>
                                <div class="slider-labels">
                                    <span>Dry</span>
                                    <span>Wet</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label" for="clock-decay">Reverb Decay</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="clock-decay" min="5" max="40" step="1" value="25">
                                </div>
                                <div class="slider-labels">
                                    <span>5s</span>
                                    <span>40s</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Current Tempo</label>
                            <div class="tempo-display">
                                <span id="clock-tempo-display">60 BPM</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="clock-info">
                    <p>Realistic grandfather clock ticking with adjustable tempo and massive reverb for ambient atmosphere.</p>
                </div>
            </div>
        </div>

        <!-- Settings section -->
        <div class="control-section" id="settings-section">
            <div class="section-header" onclick="toggleSection('settings')">
                <div class="section-title">
                    <div class="section-icon settings-icon">‚öôÔ∏è</div>
                    <div>
                        <div class="section-info">Settings</div>
                    </div>
                </div>
                <button class="expand-btn" id="settings-expand">
                    <span>‚ñº</span>
                </button>
            </div>
            <div class="section-content" id="settings-content">
                <div class="control-group">
                    <label class="control-label" for="volume">Master Volume</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="volume" min="-30" max="0" step="1" value="-15">
                        </div>
                        <div class="slider-labels">
                            <span>üîá Quiet</span>
                            <span>Loud üîä</span>
                        </div>
                    </div>
                </div>

                <div class="control-group" id="settings-random-interval">
                    <label class="control-label" for="random-interval">Random Change Interval</label>
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="random-interval" min="1" max="30" step="1" value="10">
                        </div>
                        <div class="slider-labels">
                            <span>1 min</span>
                            <span>30 min</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Playback Controls -->
        <div class="music-controls-cards">
            <button class="control-card play-card" id="playBtn" title="Play Music">
                <div class="card-icon">‚ñ∂Ô∏è</div>
                <div class="card-label">Play</div>
            </button>

            <button class="control-card stop-card" id="stopBtn" title="Stop Music" disabled>
                <div class="card-icon">‚èπÔ∏è</div>
                <div class="card-label">Stop</div>
            </button>

            <button class="control-card sleep-card" id="sleepBtn" title="Sleep Mode">
                <div class="card-icon">üò¥</div>
                <div class="card-label" id="sleepText">Sleep</div>
            </button>
        </div>
<!--        <div class="music-controls">-->
<!--            <button class="control-btn play-btn" id="playBtn" title="Play Music">-->
<!--                <div class="play-icon"></div>-->
<!--            </button>-->

<!--            <button class="control-btn stop-btn" id="stopBtn" title="Stop Music" disabled>-->
<!--                <div class="stop-icon"></div>-->
<!--            </button>-->

<!--            <button class="sleep-btn" id="sleepBtn" title="Sleep Mode">-->
<!--                <span class="sleep-icon">üò¥</span>-->
<!--                <span id="sleepText">Sleep Mode</span>-->
<!--            </button>-->
<!--        </div>-->

    </div>

    <!-- Visualizer -->
    <div class="visualizer" id="waves">
    </div>

    <div class="info">
        <p>By <a href="https://github.com/mrbarge/mood">mrbarge</a>, with ‚ù§Ô∏è to <a href="https://tonejs.github.io/">tone.js</a></p>
    </div>
</div>

<script>
    // Global variables
    let musicManager = null;
    let melodyManager = null;
    let waveManager = null;
    let clockManager = null;
    let sleepManager = null;
    let clockInitialized = false;
    let isPlaying = false;
    let activeNotes = {};
    let currentActiveMood = "calm";
    let visualizerInterval = null;

    // Create audio context and effects (global audio nodes)
    const masterVolume = new Tone.Volume(-15).toDestination();

    const reverb = new Tone.Reverb({
        decay: 10,
        wet: 0.5,
        preDelay: 0.01
    }).connect(masterVolume);

    const delay = new Tone.FeedbackDelay({
        delayTime: "8n",
        feedback: 0.4,
        wet: 0.3
    }).connect(reverb);

    const filter = new Tone.Filter({
        type: "lowpass",
        frequency: 2000,
        Q: 1
    }).connect(delay);

    // Initialize UI elements
    const startButton = document.getElementById("playBtn");
    const stopButton = document.getElementById("stopBtn");
    const sleepButton = document.getElementById("sleepBtn");
    const moodSelect = document.getElementById("mood");
    const densitySlider = document.getElementById("density");
    const reverbSlider = document.getElementById("reverb");
    const volumeSlider = document.getElementById("volume");
    const randomIntervalSlider = document.getElementById("random-interval");
    const wavesContainer = document.getElementById("waves");

    // Melody elements
    const melodyToggle = document.getElementById("melody-toggle");
    const melodicInstrumentSelect = document.getElementById("melodic-instrument");
    const melodicFrequencySlider = document.getElementById("melodic-frequency");
    const melodicReverbSlider = document.getElementById("melodic-reverb");

    // Wave elements
    const noiseToggle = document.getElementById("noise-toggle");

    // Clock elements
    const clockToggle = document.getElementById("clock-toggle");

    // Sound engine element
    const soundEngineSelect = document.getElementById("sound-engine");

    // Scale definitions for different moods
    const scales = {
        calm: ["C3", "D3", "E3", "G3", "A3", "C4", "D4", "E4", "G4", "A4", "C5"],
        ethereal: ["D3", "F#3", "A3", "B3", "D4", "F#4", "A4", "B4", "D5"],
        mysterious: ["C3", "D#3", "F3", "G#3", "B3", "C4", "D#4", "F4", "G#4", "B4"],
        melancholic: ["A2", "C3", "D3", "E3", "F3", "A3", "C4", "D4", "E4", "F4", "A4"],
        hopeful: ["G3", "A3", "B3", "D4", "E4", "G4", "A4", "B4", "D5", "E5"],
        dreamy: ["C3", "D3", "E3", "F#3", "G3", "A3", "B3", "C4", "D4", "E4", "F#4", "G4", "A4", "B4", "C5"],
        nostalgic: ["A2", "B2", "C3", "D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4"],
        peaceful: ["D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5"],
        serene: ["C3", "D3", "E3", "G3", "A3", "C4", "D4", "E4", "G4", "A4", "C5", "D5", "E5", "G5"]
    };

    const melodicPatterns = {
        calm: ["E4", "G4", "C5"],
        ethereal: ["F#4", "B4", "D5"],
        mysterious: ["D#4", "G#4", "C5"],
        melancholic: ["C4", "E4", "A4"],
        hopeful: ["B4", "D5", "G4"],
        dreamy: ["E4", "F#4", "A4", "B4"],
        nostalgic: ["C4", "E4", "F4", "A4"],
        peaceful: ["D4", "F4", "A4", "C5"],
        serene: ["E4", "G4", "C5"]
    };

    // ===============================================
    // CORE UI FUNCTIONS
    // ===============================================

    // Toggle section expansion
    function toggleSection(sectionName) {
        const section = document.getElementById(`${sectionName}-section`);
        const content = document.getElementById(`${sectionName}-content`);
        const expandBtn = document.getElementById(`${sectionName}-expand`);

        if (!section || !content || !expandBtn) return;

        const isExpanded = section.classList.contains('expanded');

        if (isExpanded) {
            section.classList.remove('expanded');
            content.classList.remove('expanded');
            expandBtn.classList.remove('expanded');
        } else {
            section.classList.add('expanded');
            content.classList.add('expanded');
            expandBtn.classList.add('expanded');
        }
    }

    // Update status displays
    function updateMoodStatus() {
        const status = document.getElementById('mood-status');
        if (!status || !moodSelect) return;

        const selectedOption = moodSelect.options[moodSelect.selectedIndex];
        if (selectedOption && selectedOption.value === 'random') {
            status.textContent = 'Random Mode';
        } else {
            status.textContent = selectedOption ? selectedOption.text : 'Calm';
        }
    }

    function handleMelodicReverbChange() {
        const melodicReverbSlider = document.getElementById('melodic-reverb');
        if (!melodicReverbSlider || !melodyManager) return;

        const reverbAmount = parseFloat(melodicReverbSlider.value);
        console.debug(`Setting melodic reverb to: ${reverbAmount}`);

        // Update reverb for all slots (each slot gets slightly different reverb)
        for (let i = 0; i < melodyManager.getCurrentSlotCount(); i++) {
            const slotReverb = reverbAmount + (i * 0.1); // Each layer gets more reverb
            melodyManager.updateSlotConfig(i, {
                reverbAmount: Math.min(1.0, slotReverb)
            });
        }
    }

    function updateMelodyStatus() {
        const status = document.getElementById('melody-status');
        const instrumentSelect = document.getElementById('melodic-instrument');

        if (!status || !melodyManager) return;

        const slotCount = melodyManager.getCurrentSlotCount();

        if (instrumentSelect) {
            const selectedValue = instrumentSelect.value;
            const selectedOption = instrumentSelect.options[instrumentSelect.selectedIndex];

            if (selectedValue === 'mixed') {
                status.textContent = `${slotCount} Layers: Mixed Instruments`;
            } else if (selectedValue === 'random') {
                status.textContent = `${slotCount} Layers: Random Mode`;
            } else {
                const instrumentName = selectedOption ? selectedOption.text.replace(' (All Layers)', '') : 'Piano';
                status.textContent = `${slotCount} Layer${slotCount > 1 ? 's' : ''}: ${instrumentName}`;
            }
        } else {
            status.textContent = `${slotCount} Layer${slotCount > 1 ? 's' : ''}: Piano`;
        }
    }

    function updateWavesStatus() {
        const status = document.getElementById('waves-status');
        if (!status) return;

        status.textContent = (noiseToggle && noiseToggle.checked) ? 'On' : 'Off';
    }

    function updateSoundEngineStatus(engineName = null) {
        const status = document.getElementById('sound-engine-status');
        if (!status) return;

        if (engineName) {
            status.textContent = engineName;
        } else if (soundEngineSelect) {
            const selectedOption = soundEngineSelect.options[soundEngineSelect.selectedIndex];
            if (selectedOption && selectedOption.value === 'random') {
                status.textContent = 'Random Mode';
            } else {
                status.textContent = selectedOption ? selectedOption.text : 'Standard Ambient';
            }
        }
    }

    function updateRandomizationStatus() {
        const moodStatus = document.getElementById('mood-random-status');
        const engineStatus = document.getElementById('engine-random-status');
        const melodyStatus = document.getElementById('melody-random-status');

        // Update mood randomization status
        if (moodStatus) {
            const isRandom = moodSelect && moodSelect.value === 'random';
            moodStatus.textContent = isRandom ? 'Auto' : 'Manual';
            moodStatus.className = isRandom ? 'status-value active' : 'status-value';
        }

        // Update engine randomization status
        if (engineStatus) {
            const isRandom = soundEngineSelect && soundEngineSelect.value === 'random';
            engineStatus.textContent = isRandom ? 'Auto' : 'Manual';
            engineStatus.className = isRandom ? 'status-value active' : 'status-value';
        }

        // Update melody randomization status
        if (melodyStatus) {
            const isRandom = melodicInstrumentSelect && melodicInstrumentSelect.value === 'random';
            melodyStatus.textContent = isRandom ? 'Auto' : 'Manual';
            melodyStatus.className = isRandom ? 'status-value active' : 'status-value';
        }
    }

    // ===============================================
    // DICE RANDOMIZER
    // ===============================================

    function randomizeEverything() {
        const diceButton = document.getElementById('dice-button');
        if (!diceButton) return;

        console.log('üé≤ Starting complete randomization with multi-melody...');

        diceButton.style.transform = 'scale(0.95)';
        diceButton.innerHTML = '<span class="dice-icon">üé≤</span> Rolling...';

        setTimeout(() => {
            // Randomize slot count (1-4 layers)
            const slotCountSlider = document.getElementById('melody-slot-count');
            if (slotCountSlider) {
                const newSlotCount = Math.floor(Math.random() * 3) + 1;
                slotCountSlider.value = newSlotCount;
                handleSlotCountChange();
                console.log('üéπ Randomized melody layers to:', newSlotCount);
            }

            // Randomize layer randomness
            const layerRandomnessSlider = document.getElementById('layer-randomness');
            if (layerRandomnessSlider) {
                const newRandomness = (Math.random() * 0.8 + 0.2).toFixed(1);
                layerRandomnessSlider.value = newRandomness;
                handleLayerRandomnessChange();
                console.log('üîÄ Randomized layer randomness to:', newRandomness);
            }

            // Randomize melody instrument assignment
            const melodicInstrumentSelect = document.getElementById('melodic-instrument');
            if (melodicInstrumentSelect) {
                const melodyOptions = ['piano', 'marimba', 'harp', 'music-box',
                    'crystal-bells', 'warm-strings', 'ethereal-choir', 'wind-chimes',
                    'glass-harmonics', 'soft-flute', 'vintage-celesta', 'mixed'
                ];
                const randomMelody = melodyOptions[Math.floor(Math.random() * melodyOptions.length)];
                melodicInstrumentSelect.value = randomMelody;
                handleMultiInstrumentChange();
                console.log('üéº Randomized melody to:', randomMelody);
            }

            // Rest of existing randomization...
            const moodSelect = document.getElementById('mood');
            if (moodSelect) {
                const moodOptions = Array.from(moodSelect.options).filter(option => option.value !== 'random');
                const randomMood = moodOptions[Math.floor(Math.random() * moodOptions.length)];
                moodSelect.value = randomMood.value;
                console.log('üé≠ Randomized mood to:', randomMood.value);
            }

            const soundEngineSelect = document.getElementById('sound-engine');
            if (soundEngineSelect) {
                const engineOptions = Array.from(soundEngineSelect.options).filter(option => option.value !== 'random');
                const randomEngine = engineOptions[Math.floor(Math.random() * engineOptions.length)];
                soundEngineSelect.value = randomEngine.value;
                console.log('üîß Randomized engine to:', randomEngine.value);
            }

            // Randomize waves
            const noiseToggle = document.getElementById('noise-toggle');
            if (noiseToggle) {
                noiseToggle.checked = Math.random() > 0.5;
                if (typeof waveManager !== 'undefined' && waveManager) {
                    waveManager.updateStatus();
                }
                console.log('üåä Randomized waves to:', noiseToggle.checked ? 'On' : 'Off');
            }

            // Randomize clock
            const clockToggle = document.getElementById('clock-toggle');
            if (clockToggle) {
                clockToggle.checked = Math.random() > 0.5;
                if (typeof clockManager !== 'undefined' && clockManager) {
                    clockManager.updateStatus();
                }
                console.log('üï∞Ô∏èÔ∏è Randomized clock to:', clockToggle.checked ? 'On' : 'Off');
            }

            // Randomize sliders
            const densitySlider = document.getElementById('density');
            const reverbSlider = document.getElementById('reverb');
            const melodicFrequencySlider = document.getElementById('melodic-frequency');
            const melodicReverbSlider = document.getElementById('melodic-reverb');

            if (densitySlider) {
                densitySlider.value = Math.floor(Math.random() * 8) + 2;
                console.log('üéµ Randomized density to:', densitySlider.value);
            }
            if (reverbSlider) {
                reverbSlider.value = (Math.random() * 0.8 + 0.2).toFixed(1);
                console.log('üîä Randomized reverb to:', reverbSlider.value);
            }
            if (melodicFrequencySlider) {
                melodicFrequencySlider.value = Math.floor(Math.random() * 8) + 2;
                console.log('üéº Randomized melody frequency to:', melodicFrequencySlider.value);
            }
            if (melodicReverbSlider) {
                const newMelodicReverb = (Math.random() * 0.6 + 0.4).toFixed(2);
                melodicReverbSlider.value = newMelodicReverb;
                handleMelodicReverbChange();
                console.log('üé≠ Randomized melodic reverb to:', newMelodicReverb);
            }

            // Apply changes if music is playing
            if (typeof isPlaying !== 'undefined' && isPlaying && typeof applySettingsGradually === 'function') {
                applySettingsGradually();
            }

            // Update all status displays
            if (typeof updateMoodStatus === 'function') updateMoodStatus();
            updateMelodyStatus();
            if (typeof updateWavesStatus === 'function') updateWavesStatus();
            if (typeof updateSoundEngineStatus === 'function') updateSoundEngineStatus();
            if (typeof updateRandomizationStatus === 'function') updateRandomizationStatus();
            updateSlotsInfoDisplay();

            // Reset button with success animation
            diceButton.style.transform = 'scale(1)';
            diceButton.innerHTML = '<span class="dice-icon">üé≤</span> Randomize Everything';

            // Brief success feedback
            diceButton.style.background = 'linear-gradient(135deg, #4ade80 0%, #22c55e 100%)';
            setTimeout(() => {
                diceButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }, 1000);

            console.log('‚úÖ Complete multi-melody randomization finished!');
        }, 800);
    }

    // ===============================================
    // EVENT HANDLERS
    // ===============================================

    async function handleSoundEngineChange() {
        if (!soundEngineSelect || !musicManager) return;

        const selectedEngine = soundEngineSelect.value;
        console.debug("üîß Sound engine changed to:", selectedEngine);

        try {
            if (selectedEngine !== "random") {
                await musicManager.setSoundEngine(selectedEngine, {
                    density: densitySlider ? parseInt(densitySlider.value) : 5,
                    reverbAmount: reverbSlider ? parseFloat(reverbSlider.value) : 0.5
                });

                if (musicManager.randomEngineInterval) {
                    clearInterval(musicManager.randomEngineInterval);
                    musicManager.randomEngineInterval = null;
                }

                updateSoundEngineStatus();
            } else {
                console.debug("üé≤ Starting random engine cycle");
                musicManager.startRandomEngineCycle();
                updateSoundEngineStatus('Random Mode');
            }

            updateRandomizationStatus();

        } catch (error) {
            console.error("Error changing sound engine:", error);
        }
    }

    function handleMoodChange() {
        if (!moodSelect || !musicManager) return;

        const selectedMood = moodSelect.value;
        console.debug("üé≠ Mood changed to:", selectedMood);

        if (selectedMood !== "random") {
            currentActiveMood = selectedMood;
            musicManager.setMood(selectedMood);

            if (musicManager.randomMoodInterval) {
                clearInterval(musicManager.randomMoodInterval);
                musicManager.randomMoodInterval = null;
            }
        } else {
            console.debug("üé≤ Starting random mood cycle");
            musicManager.startRandomMoodCycle();
        }

        updateMoodStatus();
        updateRandomizationStatus();
    }

    async function handleInstrumentChange() {
        if (!melodyManager || !melodicInstrumentSelect) return;

        const selectedInstrument = melodicInstrumentSelect.value;
        console.debug("üéπ Instrument changed to:", selectedInstrument);

        try {
            if (selectedInstrument !== "random" && melodyToggle?.checked) {
                await melodyManager.setInstrument(selectedInstrument, {
                    volume: -5,
                    reverbAmount: melodicReverbSlider ? parseFloat(melodicReverbSlider.value) : 0.8
                });

                if (isPlaying) {
                    const effectiveMood = moodSelect?.value === "random" ? currentActiveMood : (moodSelect?.value || 'calm');
                    const currentScale = scales[effectiveMood];
                    const melodicPattern = melodicPatterns[effectiveMood];

                    await melodyManager.start(currentScale, melodicPattern);
                }
            } else if (selectedInstrument === "random") {
                melodyManager.startRandomCycle();
            } else if (!melodyToggle?.checked) {
                melodyManager.stop();
            }

            updateMelodyStatus();
            updateRandomizationStatus();

        } catch (error) {
            console.error("Error changing instrument:", error);
        }
    }

    function toggleMelody(event) {
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        const melodyToggle = document.getElementById('melody-toggle');
        console.debug("Multi-melody toggle called, enabled:", melodyToggle?.checked);

        if (melodyManager) {
            melodyManager.setEnabled(melodyToggle?.checked || false);
        }

        if (typeof isPlaying !== 'undefined' && isPlaying) {
            handleMultiInstrumentChange();
        }

        updateMelodyStatus();
        updateSlotsInfoDisplay();
    }

    async function toggleWaves() {
        console.log('üåä Toggling ocean waves...');

        if (!waveManager) {
            waveManager = new OceanWaveManager();
        }

        try {
            await waveManager.toggle();
            updateWavesStatus();
            console.log('‚úÖ Waves toggled successfully');
        } catch (error) {
            console.error('‚ùå Error toggling waves:', error);
        }
    }

    // ===============================================
    // START/STOP MUSIC
    // ===============================================

    async function startMusic() {
        if (typeof isPlaying !== 'undefined' && isPlaying) return;

        console.log('üéµ Starting ambient music system with multi-melody...');

        try {
            await Tone.start();

            if (typeof isPlaying !== 'undefined') {
                isPlaying = true;
            }
            if (typeof activeNotes !== 'undefined') {
                activeNotes = {};
            }

            const startButton = document.getElementById('playBtn');
            const stopButton = document.getElementById('stopBtn');
            if (startButton) startButton.disabled = true;
            if (stopButton) stopButton.disabled = false;

            // Initialize music manager if not already done
            if (!musicManager) {
                musicManager = new AmbientMusicManager();
            }

            // Set up sound engine (existing logic)
            const soundEngineSelect = document.getElementById('sound-engine');
            const selectedEngine = soundEngineSelect?.value || 'standard';
            console.debug("Starting with engine:", selectedEngine);

            if (selectedEngine !== "random") {
                await musicManager.setSoundEngine(selectedEngine, {
                    density: densitySlider ? parseInt(densitySlider.value) : 5,
                    reverbAmount: reverbSlider ? parseFloat(reverbSlider.value) : 0.5
                });
            } else {
                const availableEngines = musicManager.getAvailableSoundEngines();
                const randomEngine = availableEngines[Math.floor(Math.random() * availableEngines.length)];
                console.log('üé≤ Starting with random engine:', randomEngine.key);

                await musicManager.setSoundEngine(randomEngine.key, {
                    density: densitySlider ? parseInt(densitySlider.value) : 5,
                    reverbAmount: reverbSlider ? parseFloat(reverbSlider.value) : 0.5
                });

                updateSoundEngineStatus(randomEngine.name);
            }

            // Initialize mood (existing logic)
            const moodSelect = document.getElementById('mood');
            if (moodSelect?.value !== "random") {
                currentActiveMood = moodSelect.value;
            } else {
                const availableMoods = musicManager.getAvailableMoods();
                currentActiveMood = availableMoods[Math.floor(Math.random() * availableMoods.length)];
            }

            musicManager.setMood(currentActiveMood);

            // Start random cycles if needed
            if (moodSelect?.value === "random") {
                musicManager.startRandomMoodCycle();
            }
            if (soundEngineSelect?.value === "random") {
                musicManager.startRandomEngineCycle();
            }

            // Update audio settings (existing logic)
            if (reverbSlider && typeof reverb !== 'undefined') {
                reverb.wet.value = parseFloat(reverbSlider.value);
            }
            if (volumeSlider && typeof masterVolume !== 'undefined') {
                masterVolume.volume.value = parseInt(volumeSlider.value);
            }

            if (typeof Tone !== 'undefined') {
                Tone.Transport.bpm.value = 60;
                Tone.Transport.start();
            }

            // Start the sound engine
            await musicManager.start();

            // Handle multi-melody instruments
            const melodyToggle = document.getElementById('melody-toggle');
            if (melodyToggle?.checked && melodyManager) {
                console.log('üéπ Starting multi-melody system...');

                // Make sure melodyManager is properly initialized
                if (melodyManager.getCurrentSlotCount() === 0) {
                    melodyManager.initializeSlots(1);
                }

                // Set up instruments based on current selection
                await handleMultiInstrumentChange();

                // Start playback with current scale and pattern
                const effectiveMood = getCurrentEffectiveMood();
                const currentScale = typeof scales !== 'undefined' ? scales[effectiveMood] : [];
                const melodicPattern = typeof melodicPatterns !== 'undefined' ? melodicPatterns[effectiveMood] : [];

                if (currentScale.length > 0 && melodicPattern.length > 0) {
                    await melodyManager.start(currentScale, melodicPattern);
                    console.log('‚úÖ Multi-melody started successfully');
                }
            }


            if (noiseToggle?.checked) {
                await toggleWaves();
            }

            if (clockToggle?.checked) {
                await toggleClock();
            }

            // Start visualizer (existing logic)
            if (typeof startVisualizer === 'function') {
                startVisualizer();
            }

            // Update status displays
            updateSlotsInfoDisplay();

            console.log('‚úÖ Music started successfully with multi-melody support!');

        } catch (error) {
            console.error('‚ùå Error starting music:', error);

            // Reset UI on error
            if (typeof isPlaying !== 'undefined') {
                isPlaying = false;
            }
            const startButton = document.getElementById('playBtn');
            const stopButton = document.getElementById('stopBtn');

            if (startButton) startButton.disabled = false;
            if (stopButton) stopButton.disabled = true;
        }
    }

    function stopMusic() {
        console.log('üõë Stopping ambient music system...');

        if (typeof isPlaying !== 'undefined') {
            isPlaying = false;
        }

        // Stop all managers
        if (musicManager) {
            musicManager.stop();
        }

        if (melodyManager) {
            melodyManager.stop();
            console.log('üéπ Multi-melody stopped');
        }

        if (waveManager) {
            noiseToggle.checked = false;
            updateWavesStatus();
            waveManager.toggle();
            console.log('üåä Wave manager stopped');
        }

        if (clockManager) {
            clockToggle.checked = false;
            updateClockStatus();
            clockManager.toggle();
            console.log('üï∞Ô∏è Clock manager stopped');
        }

        // Stop transport (existing logic)
        if (typeof Tone !== 'undefined') {
            Tone.Transport.stop();
        }

        // Update UI (existing logic)
        const startButton = document.getElementById('playBtn');
        const stopButton = document.getElementById('stopBtn');
        if (startButton) startButton.disabled = false;
        if (stopButton) stopButton.disabled = true;

        // Stop visualizer (existing logic)
        if (typeof visualizerInterval !== 'undefined' && visualizerInterval) {
            clearInterval(visualizerInterval);
            visualizerInterval = null;
        }

        // Clear active notes (existing logic)
        if (typeof activeNotes !== 'undefined') {
            activeNotes = {};
        }

        // Update displays
        updateSlotsInfoDisplay();

        console.log("‚úÖ Music stopped successfully");
    }

    // ===============================================
    // VISUALIZER
    // ===============================================

    function startVisualizer() {
        // Clear any existing interval
        if (visualizerInterval) {
            clearInterval(visualizerInterval);
        }

        const waves = document.querySelectorAll('.wave');

        visualizerInterval = setInterval(() => {
            // Update each wave based on audio activity
            waves.forEach((wave, index) => {
                if (isPlaying) {
                    // Change color based on active instruments
                    if (noiseToggle?.checked && index % 4 === 0) {
                        // Blue-green for ocean waves
                        wave.style.backgroundColor = `hsla(${180 + Math.random() * 40}, 80%, 70%, 0.2)`;
                    } else if (melodicInstrumentSelect?.value !== "none" && index % 5 === 0) {
                        // Gold/yellow for melodic instruments
                        wave.style.backgroundColor = `hsla(${40 + Math.random() * 20}, 90%, 65%, 0.25)`;
                    } else {
                        // Create random but smooth movements
                        const heightPercent = Math.random() * 50 + 10;
                        wave.style.height = `${heightPercent}%`;

                        // Add some color variation based on active notes
                        const hue = (index * 9) % 360;
                        wave.style.backgroundColor = `hsla(${hue}, 80%, 70%, 0.2)`;
                    }
                } else {
                    wave.style.height = "30%";
                    wave.style.backgroundColor = "rgba(255, 255, 255, 0.2)";
                }
            });
        }, 200);
    }

    // ===============================================
    // SETTINGS APPLICATION
    // ===============================================

    async function applySettingsGradually() {
        if (!isPlaying) return;

        console.log('üîÑ Applying settings changes gradually...');

        try {
            // Gradually ramp reverb changes
            if (reverbSlider) {
                const targetReverb = parseFloat(reverbSlider.value);
                reverb.wet.rampTo(targetReverb, 1.5);
            }

            // Handle mood change during playback
            if (moodSelect?.value !== "random" && musicManager) {
                currentActiveMood = moodSelect.value;
                musicManager.setMood(currentActiveMood);
            }

            // Handle sound engine change during playback
            await handleSoundEngineChange();

            // Handle instrument change during playback
            await handleInstrumentChange();

            // Update wave system settings if active
            if (waveManager && waveManager.isActive()) {
                waveManager.updateVolume();
                waveManager.updateNoiseType();
                waveManager.updateFilter();
                waveManager.updateBaseLevel();
            }

            // Update configuration
            if (musicManager) {
                musicManager.updateConfig({
                    density: densitySlider ? parseInt(densitySlider.value) : 5,
                    reverbAmount: reverbSlider ? parseFloat(reverbSlider.value) : 0.5
                });
            }

            console.log('‚úÖ Settings applied successfully');

        } catch (error) {
            console.error('‚ùå Error applying settings:', error);
        }
    }

    function setupMultiMelodyEventListeners() {
        // Slot count slider
        const slotCountSlider = document.getElementById('melody-slot-count');
        if (slotCountSlider) {
            slotCountSlider.addEventListener('input', handleSlotCountChange);
        }

        // Layer randomness slider
        const layerRandomnessSlider = document.getElementById('layer-randomness');
        if (layerRandomnessSlider) {
            layerRandomnessSlider.addEventListener('input', handleLayerRandomnessChange);
        }

        // Enhanced instrument selection
        const melodicInstrumentSelect = document.getElementById('melodic-instrument');
        if (melodicInstrumentSelect) {
            melodicInstrumentSelect.addEventListener('change', handleMultiInstrumentChange);
        }

        // Enhanced melodic reverb slider
        const melodicReverbSlider = document.getElementById('melodic-reverb');
        if (melodicReverbSlider) {
            melodicReverbSlider.addEventListener('input', handleMelodicReverbChange);
        }

        console.log('‚úÖ Multi-melody event listeners set up');
    }

    function getInstrumentDisplayName(instrumentKey) {
        const displayNames = {
            'piano': 'Piano',
            'rhythmic-piano': 'Rhythmic Piano',
            'marimba': 'Marimba',
            'harp': 'Harp',
            'music-box': 'Music Box',
            'glitch-electronic': 'Glitch Electronic',
            'sampled-piano': 'Sampled Piano',
            'crystal-bells': 'Crystal Bells',
            'warm-strings': 'Warm Strings',
            'ethereal-choir': 'Ethereal Choir',
            'wind-chimes': 'Wind Chimes',
            'glass-harmonics': 'Glass Harmonics',
            'soft-flute': 'Soft Flute',
            'vintage-celesta': 'Vintage Celesta',
        };
        return displayNames[instrumentKey] || instrumentKey;
    }

    function handleSlotCountChange() {
        const slotCountSlider = document.getElementById('melody-slot-count');
        if (!slotCountSlider || !melodyManager) return;

        const newCount = parseInt(slotCountSlider.value);
        console.debug(`Changing melody layers to: ${newCount}`);

        melodyManager.setSlotCount(newCount);

        // If we're in mixed mode, randomize instruments for new slots
        const instrumentSelect = document.getElementById('melodic-instrument');
        if (instrumentSelect && instrumentSelect.value === 'mixed') {
            setTimeout(async () => {
                await melodyManager.randomizeSlotInstruments();
                updateSlotsInfoDisplay();
            }, 100);
        }

        updateSlotsInfoDisplay();
        updateMelodyStatus();

        console.log(`‚úÖ Melody layers changed to: ${newCount}`);
    }

    function getCurrentEffectiveMood() {
        const moodSelect = document.getElementById('mood');
        if (moodSelect?.value === "random") {
            return typeof currentActiveMood !== 'undefined' ? currentActiveMood : 'calm';
        }
        return moodSelect?.value || 'calm';
    }

    function getReverbAmount() {
        const melodicReverbSlider = document.getElementById('melodic-reverb');
        return melodicReverbSlider ? parseFloat(melodicReverbSlider.value) : 0.8;
    }

    function handleLayerRandomnessChange() {
        const layerRandomnessSlider = document.getElementById('layer-randomness');
        if (!layerRandomnessSlider || !melodyManager) return;

        const randomnessLevel = parseFloat(layerRandomnessSlider.value);
        console.debug(`Setting layer randomness to: ${randomnessLevel}`);

        // Update randomness for all slots with different patterns per slot
        for (let i = 0; i < melodyManager.getCurrentSlotCount(); i++) {
            melodyManager.updateSlotConfig(i, {
                randomness: {
                    timing: 0.2 + (randomnessLevel * 0.6) + (i * 0.1), // Each layer more random
                    noteChoice: 0.1 + (randomnessLevel * 0.4) + (i * 0.05),
                    octaveShift: i > 0 ? randomnessLevel * 0.3 : 0 // Only higher layers shift octaves
                }
            });
        }

        console.log(`‚úÖ Layer randomness updated to: ${randomnessLevel}`);
    }

    async function handleMultiInstrumentChange() {
        const instrumentSelect = document.getElementById('melodic-instrument');
        const melodyToggle = document.getElementById('melody-toggle');
        if (!instrumentSelect || !melodyManager) return;

        const selectedInstrument = instrumentSelect.value;
        console.debug(`Multi-instrument changed to: ${selectedInstrument}`);

        try {
            if (selectedInstrument === 'mixed') {
                // Assign different instruments to each slot
                console.log('üéº Setting mixed instruments...');
                await melodyManager.randomizeSlotInstruments();

            } else if (selectedInstrument === 'random') {
                // Start random cycling for all slots
                console.log('üé≤ Starting random instrument cycling...');
                melodyManager.startRandomCycle();

            } else if (selectedInstrument !== 'random') {
                // Set all slots to the same instrument
                console.log(`üéπ Setting all layers to: ${selectedInstrument}`);
                await melodyManager.setAllSlotsToInstrument(selectedInstrument, {
                    reverbAmount: getReverbAmount()
                });
            }

            // Start playback if enabled and playing
            if (melodyToggle?.checked && typeof isPlaying !== 'undefined' && isPlaying) {
                const effectiveMood = getCurrentEffectiveMood();
                const currentScale = typeof scales !== 'undefined' ? scales[effectiveMood] : [];
                const melodicPattern = typeof melodicPatterns !== 'undefined' ? melodicPatterns[effectiveMood] : [];

                console.log('üéµ Starting multi-melody playback...');
                await melodyManager.start(currentScale, melodicPattern);
            }

            updateSlotsInfoDisplay();
            updateMelodyStatus();

            console.log('‚úÖ Multi-instrument change completed');

        } catch (error) {
            console.error("‚ùå Error in multi-instrument change:", error);
        }
    }

    // ===============================================
    // INITIALIZATION
    // ===============================================

    // Initialize the new sound system
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üéµ Initializing Ambient Music System...');

        // Initialize managers
        musicManager = new AmbientMusicManager();
        waveManager = new OceanWaveManager();
        melodyManager = new MultiMelodyManager();
        clockManager = new GrandfatherClockManager();
        sleepManager = new SleepModeManager();

        // Set initial sound engine
        if (musicManager) {
            musicManager.setSoundEngine('standard', {
                density: densitySlider ? parseInt(densitySlider.value) : 5,
                reverbAmount: reverbSlider ? parseFloat(reverbSlider.value) : 0.5
            });
        }

        melodyManager.initializeSlots(1); // Start with 1 slot

        // Update the UI to show multi-melody controls
        updateMelodyStatus();
        updateSlotsInfoDisplay();

        // Set up additional event listeners
        setupMultiMelodyEventListeners();

        // Create wave elements for visualizer
        if (wavesContainer) {
            for (let i = 0; i < 40; i++) {
                const wave = document.createElement("div");
                wave.className = "wave";
                wavesContainer.appendChild(wave);
            }
        }

        // Update status displays
        updateMoodStatus();
        updateMelodyStatus();
        updateWavesStatus();
        updateSoundEngineStatus();
        updateRandomizationStatus();

        // Set up event listeners
        if (startButton) startButton.addEventListener("click", () => {
            startMusic();
            updatePlayButton(true);
        });
        if (stopButton) stopButton.addEventListener("click", () => {
            stopMusic();
            updatePlayButton(false);
        });
        if (soundEngineSelect) soundEngineSelect.addEventListener("change", handleSoundEngineChange);
        if (moodSelect) moodSelect.addEventListener("change", handleMoodChange);
        if (melodicInstrumentSelect) melodicInstrumentSelect.addEventListener("change", handleInstrumentChange);
        if (noiseToggle) noiseToggle.addEventListener("change", toggleWaves);
        if (melodyToggle) melodyToggle.addEventListener("change", toggleMelody);

        // Slider event listeners
        if (reverbSlider) {
            reverbSlider.addEventListener("input", (e) => {
                reverb.wet.value = parseFloat(e.target.value);
                if (musicManager) {
                    musicManager.updateConfig({ reverbAmount: parseFloat(e.target.value) });
                }
            });
        }

        if (densitySlider) {
            densitySlider.addEventListener("input", (e) => {
                if (musicManager) {
                    musicManager.updateConfig({ density: parseInt(e.target.value) });
                }
            });
        }

        if (volumeSlider) {
            volumeSlider.addEventListener("input", (e) => {
                masterVolume.volume.value = parseInt(e.target.value);
            });
        }

        if (melodicReverbSlider) {
            melodicReverbSlider.addEventListener("input", function() {
                const reverbAmount = parseFloat(this.value);
                console.debug("Setting melodic reverb to:", reverbAmount);
                if (melodyManager) {
                    melodyManager.updateReverbAmount(reverbAmount);
                }
            });
        }

        // Dice button event listener
        const diceButton = document.getElementById('dice-button');
        if (diceButton) {
            diceButton.addEventListener('click', randomizeEverything);
        }

        // Clock-specific setup
        console.log('üï∞Ô∏è Setting up clock integration...');
        const tempoSlider = document.getElementById('clock-tempo');
        if (tempoSlider) {
            tempoSlider.addEventListener('input', function() {
                console.log('üï∞Ô∏è Tempo slider moved to:', tempoSlider.value);
                updateClockTempoDisplay();
            });
        }
        updateClockTempoDisplay();
        updateClockStatus();
        console.log('üï∞Ô∏è Clock integration setup complete');

        console.log('‚úÖ Ambient Music System initialized successfully');
    });

    // Handle page unload
    window.addEventListener('beforeunload', function() {
        if (melodyManager) {
            melodyManager.dispose();
        }
        if (musicManager) {
            musicManager.stop();
        }
        if (clockManager) {
            clockManager.dispose();
        }
    });

    async function initializeClock() {
        console.log('üï∞Ô∏è Initializing clock from integration...');

        if (clockInitialized) {
            console.log('üï∞Ô∏è Clock already initialized');
            return;
        }

        try {
            clockManager = new GrandfatherClockManager();
            await clockManager.initialize();
            clockInitialized = true;
            console.log('üï∞Ô∏è Clock integration complete');
        } catch (error) {
            console.error('üï∞Ô∏è Clock initialization failed:', error);
        }
    }

    async function toggleClock() {
        console.log('üï∞Ô∏è toggleClock() called from UI');

        // Initialize on first use
        if (!clockInitialized) {
            await initializeClock();
        }

        if (clockManager) {
            await clockManager.toggle();
        } else {
            console.error('üï∞Ô∏è clockManager not available');
        }
    }

    function updateClockStatus() {
        console.log('üï∞Ô∏è updateClockStatus() called');

        const status = document.getElementById('clock-status');
        const clockToggle = document.getElementById('clock-toggle');

        if (status && clockToggle) {
            status.textContent = clockToggle.checked ? 'On' : 'Off';
            console.log(`üï∞Ô∏è Status set to: ${status.textContent}`);
        } else {
            console.warn('üï∞Ô∏è Status elements not found');
        }

        // Update tempo display
        updateClockTempoDisplay();
    }

    function updateClockTempoDisplay() {
        const tempoSlider = document.getElementById('clock-tempo');
        const tempoDisplay = document.getElementById('clock-tempo-display');

        if (tempoSlider && tempoDisplay) {
            tempoDisplay.textContent = `${tempoSlider.value} BPM`;
        }
    }

    function updatePlayButton(isPlaying) {
        const playCard = document.getElementById('playBtn');
        const stopCard = document.getElementById('stopBtn');
        const playLabel = playCard.querySelector('.card-label');
        const playIcon = playCard.querySelector('.card-icon');

        if (isPlaying) {
            // Change to pause state
            playIcon.textContent = '‚è∏Ô∏è';
            playLabel.textContent = 'Playing';
            playCard.disabled = true;
            stopCard.disabled = false;
        } else {
            // Change to play state
            playIcon.textContent = '‚ñ∂Ô∏è';
            playLabel.textContent = 'Play';
            playCard.disabled = false;
            stopCard.disabled = true;
        }
    }

    // Auto-update slots display every few seconds
    setInterval(() => {
        if (typeof isPlaying !== 'undefined' && isPlaying && melodyManager) {
            updateSlotsInfoDisplay();
        }
    }, 3000);

</script>
</body>
</html>